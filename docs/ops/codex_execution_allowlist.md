````md
# Codex Execution Allowlist (Autonomous Mode)

**Codex è‡ªæ²»æ‰§è¡Œæˆæƒæ¸…å• Â· v4.3ï¼ˆReplace v4.2ï¼‰**

---

## 0. å®šä½ï¼ˆWhat Codex Isï¼‰

Codex åœ¨æœ¬ä»“åº“ä¸­çš„è§’è‰²è¢«æ˜ç¡®ä¸ºï¼š

> **è‡ªæ²»æ‰§è¡Œä½“ï¼ˆAutonomous Engineering Executorï¼‰**

å…¶èŒè´£æ˜¯åœ¨ **ç‹¬ç«‹åˆ†æ”¯ï¼ˆfeature/* / feat/* / codex/* / experiment/*ï¼‰** å†…ï¼Œ
å›´ç»•æ—¢å®šç›®æ ‡è¿›è¡Œ **è¿ç»­çš„ä»£ç è¿­ä»£ã€éªŒè¯ä¸äº¤äº’å®Œå–„**ï¼Œ
å¹¶åœ¨ **ä¸éœ€è¦äººå·¥é€æ­¥æˆæƒ** çš„å‰æä¸‹ï¼Œå®Œæˆä»¥ä¸‹é—­ç¯ï¼š

* å®ç°æ”¹åŠ¨
* è¿è¡ŒéªŒè¯
* ä¿®å¤å¤±è´¥
* é‡å¤è¿­ä»£
* è¾“å‡ºå¯å®¡è®¡ç»“æœ

Codex **ä¸æ˜¯ç®¡ç†å‘˜**ï¼Œä¹Ÿ **ä¸æ˜¯å†³ç­–è€…**ï¼›
Codex æ˜¯ä¸€ä¸ª **è¢«ä¸¥æ ¼çº¦æŸçš„å·¥ç¨‹æ‰§è¡Œå•å…ƒ**ã€‚

---

## 1. æ‰§è¡Œè¾¹ç•Œæ€»åŸåˆ™ï¼ˆHard Rulesï¼‰

### 1.1 åˆ†æ”¯çº¦æŸï¼ˆæœ€é‡è¦ï¼‰

Codex **åªèƒ½** åœ¨ä»¥ä¸‹åˆ†æ”¯ç±»å‹ä¸­æ‰§è¡Œè‡ªæ²»æ“ä½œï¼š

* `feat/*`
* `feature/*`
* `codex/*`
* `experiment/*`

âŒ ä¸¥ç¦ï¼š

* `main`
* `master`
* `release/*`
* ä»»ä½•å·²æ‰“ tag çš„åˆ†æ”¯

è‹¥å½“å‰åˆ†æ”¯ä¸ç¬¦åˆè¦æ±‚ï¼ŒCodex **å¿…é¡»ç«‹å³åœæ­¢å¹¶æŠ¥å‘Š**ã€‚

**åˆ†æ”¯åˆ¤å®šè§„åˆ™ï¼š**

```bash
git branch --show-current
````

å…è®¸çš„åˆ†æ”¯æ­£åˆ™ï¼š

```
^(feat|feature|codex|experiment)\/.+
```

---

### 1.2 ç¯å¢ƒçº¦æŸ

* ä»…å…è®¸ `ENV=dev` / `ENV=test`
* âŒ ç¦æ­¢ `ENV=prod`
* âŒ ç¦æ­¢ä½¿ç”¨ `.env.prod`
* âŒ ç¦æ­¢è®¾ç½®æˆ–ä½¿ç”¨ `PROD_DANGER=1`

> `.env.prod` æ–‡ä»¶å…è®¸å­˜åœ¨ï¼ˆä½œä¸ºæ¨¡æ¿/å‚è€ƒï¼‰ï¼Œä½†ç¦æ­¢åœ¨ Codex è‡ªæ²»æ‰§è¡Œä¸­å¯ç”¨ `ENV=prod` æˆ–è®¾ç½® `PROD_DANGER=1`ã€‚

---

### 1.3 æ‰§è¡Œæ–¹å¼çº¦æŸï¼ˆMakefile ä¼˜å…ˆï¼‰

* **é»˜è®¤åŸåˆ™**ï¼š
  æ‰€æœ‰ **è¿è¡Œæ€ / å®¹å™¨ / æ•°æ®åº“ / æœåŠ¡çŠ¶æ€å˜æ›´ / è¿œç«¯çŠ¶æ€å˜æ›´**
  **å¿…é¡»é€šè¿‡ Makefile target æ‰§è¡Œ**

* **æ˜ç¡®ä¾‹å¤–**ï¼š
  Â§1.4 ä¸­åˆ—å‡ºçš„ **Safe Git å‘½ä»¤**
  ğŸ‘‰ å…è®¸ç›´æ¥æ‰§è¡Œï¼ˆä¸è¦æ±‚ Makefile å°è£…ï¼‰

âŒ ç¦æ­¢ç›´æ¥è°ƒç”¨ï¼ˆé™¤éæœ‰å¯¹åº” Makefile targetï¼‰ï¼š

* `docker compose exec ... odoo -u`
* `psql`
* `gh pr edit / comment / ready / close`
* `curl` / `python` ç›´æ¥å†™ GitHub API
* ä»»ä½•ç»•è¿‡ Makefile çš„è¿œç«¯çŠ¶æ€ä¿®æ”¹

---

### 1.3.1 PR å†…å®¹æ›´æ–°é€šé“ï¼ˆPR Update Channelï¼‰

Codex è¢«æˆæƒåœ¨ **åˆè§„åˆ†æ”¯å†…** æ›´æ–° PR å†…å®¹ï¼ˆåŒ…æ‹¬ä»£ç ä¸æ–‡æœ¬ï¼‰ï¼Œä½†å¿…é¡»æ»¡è¶³ï¼š

* âœ… **åªèƒ½é€šè¿‡ Makefile target æ‰§è¡Œ**
* âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ `git push` / `gh` / GitHub API

å…è®¸çš„ PR ç›¸å…³ Makefile targetsï¼š

* `make pr.open`

  * åˆ›å»º PRï¼ˆæˆ–è¾“å‡ºåˆ›å»ºæŒ‡å¼• / URLï¼‰

* `make pr.update`

  * æ›´æ–° PR æ ‡é¢˜ / æè¿° / labels / assignees / reviewers
  * ä¸å…è®¸ä¿®æ”¹ base åˆ†æ”¯

* `make pr.status`

  * æŸ¥è¯¢ PR çŠ¶æ€ï¼ˆåªè¯»ï¼Œå…è®¸ä»»ä½•åˆ†æ”¯ï¼‰

* `make pr.push`

  * å°†å½“å‰åˆ†æ”¯ push åˆ°è¿œç«¯ï¼Œç”¨äº **æ›´æ–° PR çš„ä»£ç å†…å®¹**
  * å¿…é¡»æ ¡éªŒï¼š

    * åˆ†æ”¯åˆæ³•
    * é prod ç¯å¢ƒ
    * é main / release

> è¯´æ˜ï¼š
> **PR å†…å®¹æ›´æ–°å±äºè¿œç«¯çŠ¶æ€å˜æ›´**ï¼Œå¿…é¡»ç»Ÿä¸€èµ° Makefile å°è£…æµç¨‹ï¼Œ
> ä»¥ä¿è¯åˆ†æ”¯æ ¡éªŒã€ç¯å¢ƒæ ¡éªŒä¸å®¡è®¡èƒ½åŠ›ã€‚

---

## 1.4 Git æ‰§è¡Œè¾¹ç•Œï¼ˆSafe Git Rulesï¼‰

> âš ï¸ æ‰€æœ‰ Git æ“ä½œä»å— Â§1.1 åˆ†æ”¯çº¦æŸ
> **åˆ†æ”¯ä¸åˆè§„æ—¶ï¼Œä»»ä½• Git å†™æ“ä½œéƒ½å¿…é¡»åœæ­¢**

---

### 1.4.1 å…è®¸çš„ Git å‘½ä»¤ï¼ˆSafe Gitï¼‰

#### A) åªè¯»ç±»ï¼ˆå…è®¸åœ¨ä»»ä½•åˆ†æ”¯æ‰§è¡Œï¼‰

ç”¨äºè¯†åˆ«ä»“åº“çŠ¶æ€ã€ç”Ÿæˆè¯æ®ã€å®šä½é—®é¢˜ï¼š

* `git status`
* `git status -sb`
* `git diff`
* `git diff --stat`
* `git diff --name-only`
* `git diff --cached`
* `git diff --cached --name-only`
* `git log --oneline -n <N>`
* `git log --oneline --decorate -n <N>`
* `git show <commit>`
* `git show --name-only <commit>`
* `git branch --show-current`
* `git rev-parse HEAD`
* `git rev-parse --short HEAD`
* `git remote -v`
* `git ls-files`
* `git grep <pattern> [-- <path>]`
* `git fetch --prune origin`

> è¯´æ˜ï¼š
> ä¸Šè¿°å‘½ä»¤ **ä¸ä¿®æ”¹å·¥ä½œåŒºã€ä¸å½±å“è¿œç«¯**ï¼Œ
> æ˜¯ Codex åšå·¥ç¨‹è‡ªæ²»ä¸è¯æ®è¾“å‡ºçš„å¿…è¦èƒ½åŠ›ã€‚

---

#### B) æœ¬åœ°å†™å…¥ï¼ˆä»…é™åˆè§„åˆ†æ”¯ï¼‰

ä»…å½±å“æœ¬åœ°å·¥ä½œåŒºï¼Œä¸å½±å“è¿œç«¯ï¼š

* `git add <path>`
* `git add -A`
* `git restore <path>`
* `git restore --staged <path>`
* `git rm <path>`
* `git commit -m "<message>"`
* `git commit --amend -m "<message>"`
* `git commit --amend --no-edit`

> âš ï¸ è¯´æ˜ï¼š
> `--no-edit` è¢«æ˜ç¡®å…è®¸ï¼Œç”¨äº**ä¿®æ­£æäº¤å†…å®¹è€Œä¸æ”¹è¯­ä¹‰è¯´æ˜**ï¼Œ
> æ˜¯è‡ªæ²»æ‰§è¡Œä¸­çš„å¸¸è§ä¸”å®‰å…¨æ“ä½œã€‚

---

#### C) åˆ†æ”¯å†…åŒæ­¥ï¼ˆä»…é™åˆè§„åˆ†æ”¯ï¼‰

* `git switch <allowed-branch>`
* `git checkout <allowed-branch>`
* `git switch -c <new-allowed-branch>`
* `git checkout -b <new-allowed-branch>`
* `git pull --ff-only origin <same-branch>`

---

### 1.4.2 æ˜ç¡®ç¦æ­¢çš„ Git å‘½ä»¤ï¼ˆHard Banï¼‰

ä»¥ä¸‹å‘½ä»¤ **ä»»ä½•æƒ…å†µä¸‹éƒ½ç¦æ­¢**ï¼š

* âŒ `git push`
  ï¼ˆ**é™¤é** é€šè¿‡ `make pr.push` / `make branch.cleanup.feature` æ‰§è¡Œï¼‰
* âŒ `git push --force / -f`
* âŒ `git reset --hard`
* âŒ `git rebase`
* âŒ `git cherry-pick`
* âŒ `git merge`
* âŒ `git tag`
* âŒ `git branch -d / -D`
  ï¼ˆ**é™¤é** é€šè¿‡ `make branch.cleanup.feature` æ‰§è¡Œï¼‰
* âŒ `git worktree`
* âŒ `git config`
* âŒ `git clean -fdx`

> âš ï¸ æ‰€æœ‰ **è¿œç«¯çŠ¶æ€å˜æ›´**
> å¿…é¡»é€šè¿‡ Makefile å°è£…æµç¨‹å®Œæˆã€‚

> è§£é‡Šï¼š
> PR çš„ä»£ç æ›´æ–° **å¿…é¡»é€šè¿‡ `make pr.push`**ï¼Œ
> ä»¥ä¾¿ç»Ÿä¸€æ³¨å…¥åˆ†æ”¯æ ¡éªŒã€è¿œç«¯ä¿æŠ¤ä¸å®¡è®¡æ—¥å¿—ã€‚

---

### 1.5 Git ä¸åˆ†æ”¯ç»‘å®šè§„åˆ™ï¼ˆCriticalï¼‰

* Codex æ‰§è¡Œä»»ä½• **Git å†™æ“ä½œ** å‰ï¼Œå¿…é¡»ç¡®è®¤ï¼š

  * å½“å‰åˆ†æ”¯ âˆˆ {feat/*, feature/*, codex/*, experiment/*}

* è‹¥æ£€æµ‹åˆ°ä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š

  * `main`
  * `master`
  * `release/*`
  * HEAD detached

  Codex **å¿…é¡»ç«‹å³åœæ­¢**ï¼Œä¸å¾—æ‰§è¡Œä»»ä½• Git å†™æ“ä½œã€‚

* å¯¹ `main` çš„åŒæ­¥ï¼š

  * ä»…å…è®¸é€šè¿‡ï¼š

    ```bash
    make main.sync
    ```

---

## 2. Codex çš„è‡ªæ²»ç”Ÿå‘½å‘¨æœŸ

åœ¨ç‹¬ç«‹åˆ†æ”¯å†…ï¼ŒCodex è¢«æˆæƒæ‰§è¡Œå®Œæ•´è‡ªæ²»å¾ªç¯ï¼š

```
ç†è§£ç›®æ ‡
â†“
ä¿®æ”¹ä»£ç 
â†“
é€‰æ‹©æ‰§è¡Œæ¨¡å¼ï¼ˆfast / gateï¼‰
â†“
æ‰§è¡ŒéªŒè¯
â†“
å¤±è´¥ â†’ å®šä½ â†’ ä¿®å¤
â†“
å†æ¬¡éªŒè¯
â†“
ç›´åˆ°é€šè¿‡æˆ–è§¦å‘åœæœºæ¡ä»¶
```

---

## 3. æ‰§è¡Œæ¨¡å¼ï¼ˆExecution Modesï¼‰

### 3.1 MODE=fastï¼ˆé»˜è®¤ Â· è¿ç»­è¿­ä»£æ¨¡å¼ï¼‰

#### é€‚ç”¨èŒƒå›´

* UI / Portal äº¤äº’è°ƒä¼˜
* Python é€»è¾‘ä¿®æ­£
* Resolver / çŠ¶æ€æœºæ¼”è¿›
* Contract è¾“å‡ºç»“æ„ä¼˜åŒ–
* æ–‡æ¡£ / è„šæœ¬ / å·¥å…·é“¾æ”¹è¿›

#### å…è®¸çš„ Make Targets

ï¼ˆä¿æŒä½ ç°æœ‰æ¸…å•ï¼Œå®Œå…¨ä¸æ”¹ï¼‰

---

### 3.2 MODE=gateï¼ˆè‡ªæ²»éªŒæ”¶æ¨¡å¼ï¼‰

Codex **è¢«æˆæƒè‡ªè¡Œè¿›å…¥ gate æ¨¡å¼**ã€‚

ï¼ˆä¿æŒä½ ç°æœ‰æ¸…å•ï¼Œå®Œå…¨ä¸æ”¹ï¼‰

---

## 4. æ¨¡å—å‡çº§æˆæƒï¼ˆå‡çº§ä¸æ˜¯é»˜è®¤ï¼‰

ï¼ˆä¿æŒä½ ç°æœ‰è§„åˆ™ï¼Œå®Œå…¨ä¸æ”¹ï¼‰

---

## 5. å¤±è´¥å³è®¸å¯ï¼ˆFailure Is Allowedï¼‰

Gate / Smoke / Snapshot å¤±è´¥ **å…è®¸å‘ç”Ÿ**ã€‚
Codex çš„è´£ä»»æ˜¯ **å®šä½ â†’ ä¿®å¤ â†’ é‡è¯•**ã€‚

---

## 5.1 System-bound Verificationï¼ˆå¼ºåˆ¶ï¼‰

**ä»»ä½•ç”± Codex äº§ç”Ÿçš„ä»£ç æ”¹åŠ¨ï¼Œå¿…é¡»åŒæ—¶æä¾› system-bound verificationã€‚**

ä¸æ¥å—ï¼š

* çœŸå®ç”¨æˆ·ç™»å½•
* æµè§ˆå™¨ç‚¹å‡»éªŒè¯
* äººå·¥ token

---

## 6. å”¯ä¸€éœ€è¦äººå·¥ä¸­æ–­çš„æƒ…å†µ

ä»…é™ä»¥ä¸‹æƒ…å½¢ï¼š

1. éœ€è¦æ”¹åŠ¨ `main` / `release`
2. éœ€è¦æ–°å¢æˆ–ä¿®æ”¹ prod ç­–ç•¥
3. ä¸å¯é€† DB æ“ä½œ
4. è¿ç»­ â‰¥3 æ¬¡ gate.full å¤±è´¥ä¸”åŸå› ä¸æ”¶æ•›
5. å¼•å…¥å…¨æ–°æ¨¡å—æˆ–å¤–éƒ¨ä¾èµ–

---

## 6.0 Codex Branch Bootstrap Rule

* `codex/*` åˆ†æ”¯é¦–æ¬¡æ¨é€å¿…é¡»äººå·¥å®Œæˆ
* è¿œç«¯åˆ†æ”¯å­˜åœ¨åï¼ŒCodex æ¥ç®¡è‡ªæ²»æµç¨‹

---

## 6.1 Branch-local autonomyï¼ˆAll allowed branchesï¼‰

åœ¨åˆè§„åˆ†æ”¯ï¼ˆ`feat/*` `feature/*` `codex/*` `experiment/*`ï¼‰å†…ï¼Œ
ä»…å…è®¸é€šè¿‡ Makefile æ‰§è¡Œä»¥ä¸‹è‡ªæ²»é—­ç¯èƒ½åŠ›ï¼š

* `make codex.preflight`
* `make codex.run FLOW=fast|snapshot|gate|pr|merge|cleanup|rollback`
* `make codex.pr`
* `make pr.open`
* `make pr.update`
* `make pr.status`
* `make pr.push`
* `make codex.sync-main`
* `make branch.cleanup.feature`

> è‹¥æŸ target å°šæœªå®ç°ï¼Œ**å¿…é¡»å…ˆè¡¥ Makefile å°è£…**ï¼Œ
> Codex ä¸å¾—ç»•è¿‡ç›´æ¥è°ƒç”¨åº•å±‚å‘½ä»¤ã€‚

---

## 7. äº§å‡ºä¸è¯æ®ï¼ˆå¿…é¡»ï¼‰

ä¸€æ¬¡è‡ªæ²»å‘¨æœŸå†…ï¼ŒCodex **å¿…é¡»äº§å‡º**ï¼š

* æ—¥å¿—æ‘˜è¦
* Gate / Smoke ç»“æœ
* Contract snapshot diffï¼ˆå¦‚æœ‰ï¼‰
* System-bound verification ç»“æœ
* æœ€ç»ˆçŠ¶æ€è¯´æ˜ï¼ˆé€šè¿‡ / é˜»å¡ï¼‰

æ¨èç›®å½•ç»“æ„ï¼š

```
artifacts/codex/<branch>/<timestamp>/
```

---

## 8. ä¸€å¥è¯æ‰§è¡Œå‡†åˆ™ï¼ˆç»™ Codex ç”¨ï¼‰

> **åªåœ¨ç‹¬ç«‹åˆ†æ”¯ï¼›
> é»˜è®¤ fastï¼›
> å‡çº§éœ€å£°æ˜ï¼›
> PR æ›´æ–°èµ° Makefileï¼›
> éªŒè¯å¿…é¡»è‡ªè¯ï¼›
> gate å¯è‡ªæ²»ï¼›
> å¤±è´¥å¯é‡è¯•ï¼›
> è¶Šæƒå³åœã€‚**

---

```
```
