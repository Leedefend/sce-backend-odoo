## Phase-3 方案（结算三单匹配·基础版）

### 1. 目标与范围
- 目标：确保结算单与合同/采购单/发票的“齐全性与一致性”，在额度控制基础上减少错付/漏付，不做复杂金额拆分。
- 范围：合同 ↔ 结算单；采购订单 ↔ 结算单；发票（占位） ↔ 结算单。仅基础校验，暂不做会计凭证和银行接口。

### 2. 模型关系（现状复盘）
- 结算单（sc.settlement.order）：project_id, contract_id, partner_id, settlement_type, amount_total, paid/remaining，付款申请一对多。
- 付款申请（payment.request）：链接 settlement_id，额度校验 + Tier 审批；完成时落资金台账。
- 资金台账（sc.treasury.ledger）：只读事实，唯一 payment_request_id，必连 settlement_id，方向/金额/状态。
- 合同（construction.contract）：已有与项目/供应商/金额的绑定，是三单匹配的主对照源。
- 采购订单（purchase.order 扩展）：已存在与项目/合同等关联（待校验现状）。
- 发票：尚无对接，作为后续占位。

风险提示（当前已知）：
- 字段重复/oldname、tracking/digits 警告；parent_path 未加 unaccent=False；不影响功能但需后续技术债处理。
- 结算单字段 contract_id/partner_id 与付款申请一致性已校验，但合同/采购/发票与结算的关系尚未硬性校验。

### 3. 基础校验设计（不拆金额）
1) 合同 ↔ 结算单：
   - 结算单.contract_id 必填（针对支出型）；project/partner 与合同一致。
   - 校验：结算单提交/批准时校验合同一致；付款申请关联结算单时已做 partner/project 校验，可追加合同一致校验（若缺）。
2) 采购单 ↔ 结算单：
   - 结算单行允许绑定 purchase.order/line（或在行上引用采购行/产品），提交时校验：采购单 project/partner 与结算单一致，且采购单状态已确认/批准。
   - 不做金额拆分，仅校验“来源齐全 + 状态正确 + 同项目/同供应商”。
3) 发票占位：
   - 结算单可预留发票引用字段（invoice_id 或 many2many），仅做齐全性提示，不拦截流程（可选软警告）。

### 4. 触发节点与阻断策略
- 结算单提交/批准：校验合同一致性、采购来源齐全且状态合规（可配置软/硬）。
- 付款申请提交/完成：沿用额度校验；新增校验结算单是否已完成基础匹配（合同/采购齐全）。
- 资金台账生成：保持只读，不新增阻断（依赖付款申请完成）。

### 5. UI 影响（最小改动）
- 结算单表单：增加“来源校验”区域/提示；行上展示采购来源；发票占位字段（可隐藏/只读）。
- 付款申请表单：沿用结算依据区；若结算单未通过基础匹配，给出红色警示并阻断提交/完成（取决于策略）。
- 不新增复杂页面，仅在现有视图上补字段+提示。

### 6. 策略配置（轻量）
- 参数化：合同校验是否硬阻断；采购校验是否硬阻断；发票是否软警告。
- 复用现有 Tier 审批：超额与匹配异常可走同一审批流升级。

### 7. 交付与验证
- 开发顺序：合同校验 → 采购校验 → 发票占位 → UI 提示 → 测试（结算单/付款申请不同组合）。
- 验证点：模块升级通过；提交/完成阻断符合策略；UI 提示清晰；资金台账仍只读。
