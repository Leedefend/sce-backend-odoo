<odoo>
    <record id="view_project_project_kanban_dashboard" model="ir.ui.view">
        <field name="name">project.project.kanban.dashboard</field>
        <field name="model">project.project</field>
        <field name="arch" type="xml">
            <kanban default_group_by="stage_id"
                    class="sc_project_dashboard_kanban o_kanban_small">
                <field name="name"/>
                <field name="project_code"/>
                <field name="stage_id"/>
                <field name="manager_id"/>
                <field name="owner_id"/>
                <field name="location"/>
                <field name="contract_no"/>
                <field name="lifecycle_state"/>
                <field name="phase_key"/>
                <field name="plan_percent"/>
                <field name="actual_percent"/>
                <field name="document_missing_count"/>
                <field name="document_required_count"/>

                <field name="dashboard_revenue_actual" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                <field name="dashboard_cost_actual" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                <field name="dashboard_profit_actual" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                <field name="dashboard_invoice_amount" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                <field name="dashboard_payment_in" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                <field name="dashboard_payment_out" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>

                <field name="budget_active_cost_target"/>
                <field name="budget_active_revenue_target"/>
                <field name="cost_ledger_amount_actual"/>
                <field name="cost_budget_gap"/>

                <field name="dashboard_progress_rate"/>
                <field name="progress_entry_count"/>
                <field name="document_completion_rate"/>

                <templates>
                    <t t-name="kanban-group-header">
                        <div class="o_kanban_header">
                            <div class="o_kanban_header_title">
                                <span t-esc="group.value"/>
                                <span class="sc-group-count" t-if="group.count">
                                    (<t t-esc="group.count"/>)
                                </span>
                            </div>
                        </div>
                    </t>
                    <t t-name="kanban-box">
                        <t t-set="revenue_raw" t-value="+((record.dashboard_revenue_actual ? record.dashboard_revenue_actual.raw_value : 0) || 0)"/>
                        <t t-set="cost_raw" t-value="+((record.dashboard_cost_actual ? record.dashboard_cost_actual.raw_value : 0) || 0)"/>
                        <t t-set="profit_raw" t-value="+((record.dashboard_profit_actual ? record.dashboard_profit_actual.raw_value : 0) || 0)"/>
                        <t t-set="invoice_raw" t-value="+((record.dashboard_invoice_amount ? record.dashboard_invoice_amount.raw_value : 0) || 0)"/>
                        <t t-set="payment_in_raw" t-value="+((record.dashboard_payment_in ? record.dashboard_payment_in.raw_value : 0) || 0)"/>
                        <t t-set="payment_out_raw" t-value="+((record.dashboard_payment_out ? record.dashboard_payment_out.raw_value : 0) || 0)"/>
                        <t t-set="plan_revenue_target_raw" t-value="+((record.budget_active_revenue_target ? record.budget_active_revenue_target.raw_value : 0) || 0)"/>
                        <t t-set="has_finance_data"
                           t-value="Math.abs(revenue_raw) || Math.abs(cost_raw) || Math.abs(invoice_raw) || Math.abs(payment_in_raw) || Math.abs(payment_out_raw)"/>

                        <t t-set="progress_raw" t-value="+((record.dashboard_progress_rate ? record.dashboard_progress_rate.raw_value : 0) || 0)"/>
                        <t t-set="progress_clamped" t-value="Math.min(Math.max(progress_raw, 0.0), 100.0)"/>
                        <t t-set="progress_entry_count" t-value="+((record.progress_entry_count ? record.progress_entry_count.raw_value : 0) || 0)"/>
                        <t t-set="has_progress_data" t-value="progress_entry_count"/>
                        <t t-set="dashoffset" t-value="has_progress_data and (100 - progress_clamped) or 100"/>

                        <t t-set="doc_rate_raw" t-value="+((record.document_completion_rate ? record.document_completion_rate.raw_value : 0) || 0)"/>
                        <t t-set="doc_rate_clamped" t-value="Math.min(Math.max(doc_rate_raw, 0.0), 100.0)"/>
                        <t t-set="doc_missing" t-value="+((record.document_missing_count ? record.document_missing_count.raw_value : 0) || 0)"/>
                        <t t-set="doc_required" t-value="+((record.document_required_count ? record.document_required_count.raw_value : 0) || 0)"/>

                        <t t-set="plan_rate_raw" t-value="+((record.plan_percent ? record.plan_percent.raw_value : 0) || 0)"/>
                        <t t-set="plan_rate_clamped" t-value="Math.min(Math.max(plan_rate_raw, 0.0), 100.0)"/>
                        <t t-set="has_plan_data" t-value="Math.abs(plan_rate_raw) || Math.abs(plan_revenue_target_raw)"/>

                        <t t-set="gap" t-value="+((record.cost_budget_gap ? record.cost_budget_gap.raw_value : 0) || 0.0)"/>
                        <t t-set="budget_target" t-value="+((record.budget_active_cost_target ? record.budget_active_cost_target.raw_value : 0) || 0.0)"/>
                        <t t-set="has_budget_data" t-value="Math.abs(budget_target) || Math.abs(plan_revenue_target_raw)"/>
                        <t t-set="risk_class"
                           t-value="gap &lt; 0 and 'sc_risk_high'
                                    or (gap &lt;= budget_target * 0.1 and 'sc_risk_warn'
                                        or 'sc_risk_ok')"/>
                        <t t-set="progress_gap" t-value="progress_clamped - plan_rate_clamped"/>

                        <div t-attf-class="o_kanban_record sc_project_card {{ risk_class }}">
                            <div class="sc-card-header">
                                <div class="sc-title-row">
                                    <span class="sc-project-name" t-esc="record.name.value or ''"/>
                                    <span class="sc-project-code" t-esc="record.project_code.value or ''"/>
                                    <t t-if="risk_class == 'sc_risk_high'">
                                        <span class="sc-badge-icon sc-badge-high">üî¥</span>
                                    </t>
                                    <t t-elif="risk_class == 'sc_risk_warn'">
                                        <span class="sc-badge-icon sc-badge-warn">üü†</span>
                                    </t>
                                    <t t-else="">
                                        <span class="sc-badge-icon sc-badge-ok">üü¢</span>
                                    </t>
                                </div>
                                <div class="sc-meta-row">
                                    <span class="badge badge-secondary" t-if="record.stage_id.value">
                                        <t t-esc="record.stage_id.value"/>
                                    </span>
                                    <span class="badge badge-light" t-if="record.lifecycle_state.value">
                                        <t t-esc="record.lifecycle_state.value"/>
                                    </span>
                                    <span class="badge badge-light" t-if="record.phase_key.value">
                                        <t t-esc="record.phase_key.value"/>
                                    </span>
                                    <span class="sc-manager" t-if="record.manager_id.value">
                                        üë§ <t t-esc="record.manager_id.value"/>
                                    </span>
                                </div>
                            </div>

                            <div class="sc-card-body">
                                <div class="sc-kpi-block">
                                    <div class="sc-kpi-row sc-kpi-bold">
                                        <span class="sc-kpi-label">Êî∂ÂÖ•</span>
                                        <span class="sc-kpi-value">
                                            <t t-if="has_finance_data">
                                                <t t-esc="record.dashboard_revenue_actual.value or '0.00'"/>
                                            </t><t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                    <div class="sc-kpi-row sc-kpi-bold">
                                        <span class="sc-kpi-label">ÊàêÊú¨</span>
                                        <span class="sc-kpi-value">
                                            <t t-if="has_finance_data">
                                                <t t-esc="record.dashboard_cost_actual.value or '0.00'"/>
                                            </t>
                                                <t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                    <div class="sc-kpi-row">
                                        <span class="sc-kpi-label">Êî∂ÂÖ•ÁõÆÊ†á</span>
                                        <span class="sc-kpi-value">
                                            <t t-if="plan_revenue_target_raw">
                                                <t t-esc="record.budget_active_revenue_target.value or '0.00'"/>
                                            </t>
                                            <t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                    <div class="sc-kpi-row sc-kpi-bold">
                                        <span class="sc-kpi-label">ÊØõÂà©</span>
                                        <span class="sc-kpi-value">
                                            <t t-if="has_finance_data">
                                                <t t-esc="record.dashboard_profit_actual.value or '0.00'"/>
                                            </t><t t-else="">‚Äî</t>
                                        </span>
                                    </div>

                                    <div class="sc-kpi-row sc-kpi-gap">
                                        <span class="sc-kpi-label">ÊàêÊú¨ÂÅèÂ∑Æ</span>
                                        <span>
                                            <t t-if="has_budget_data">
                                                <t t-if="gap &lt; 0">
                                                    <span class="badge badge-danger">Ë∂ÖÈ¢ÑÁÆó</span>
                                                </t>
                                                <t t-elif="risk_class == 'sc_risk_warn'">
                                                    <span class="badge badge-warning">Êé•Ëøë‰∏äÈôê</span>
                                                </t>
                                                <t t-else="">
                                                    <span class="badge badge-success">Ê≠£Â∏∏</span>
                                                </t>
                                            </t>
                                            <t t-else="">
                                                <span class="badge badge-secondary">Â∞öÊú™ÂΩïÂÖ•ËÆ°ÂàíÊï∞ÊçÆ</span>
                                            </t>
                                        </span>
                                    </div>
                                    <div class="sc-kpi-row">
                                        <span class="sc-kpi-label">ËøõÂ∫¶ÂÅèÂ∑Æ</span>
                                        <span>
                                            <t t-if="has_plan_data">
                                                <t t-set="sv" t-value="progress_clamped - plan_rate_clamped"/>
                                                <t t-if="sv &lt; -5">
                                                    <span class="badge badge-danger">
                                                        ËêΩÂêé <t t-esc="Math.abs(Math.round(sv))"/>%
                                                    </span>
                                                </t>
                                                <t t-elif="sv &gt; 5">
                                                    <span class="badge badge-success">
                                                        Ë∂ÖÂâç <t t-esc="Math.round(sv)"/>%
                                                    </span>
                                                </t>
                                                <t t-else="">
                                                    <span class="badge badge-success">ÊåâËÆ°Âàí</span>
                                                </t>
                                            </t>
                                            <t t-else="">
                                                <span class="badge badge-secondary">Â∞öÊú™ÂΩïÂÖ•ËÆ°ÂàíÊï∞ÊçÆ</span>
                                            </t>
                                        </span>
                                    </div>
                                </div>

                                <div t-attf-class="sc-progress-block{{ has_progress_data and '' or ' sc-progress-empty' }}">
                                    <svg viewBox="0 0 36 36" width="70" height="70">
                                        <circle cx="18" cy="18" r="16"
                                                fill="none"
                                                stroke="#eeeeee"
                                                stroke-width="3.5"/>
                                        <circle cx="18" cy="18" r="16"
                                                fill="none"
                                                t-att-stroke="has_progress_data and (risk_class == 'sc_risk_high' and '#e74c3c'
                                                              or (risk_class == 'sc_risk_warn' and '#f39c12' or '#7159c1')) or '#d6d6d6'"
                                                stroke-width="3.5"
                                                stroke-linecap="round"
                                                stroke-dasharray="100"
                                                t-att-stroke-dashoffset="dashoffset"
                                                transform="rotate(-90 18 18)"/>
                                        <text x="18" y="20.5"
                                              text-anchor="middle"
                                              font-size="9"
                                              fill="#333"
                                              t-att-class="has_progress_data and '' or 'sc-progress-empty-text'">
                                            <t t-if="has_progress_data">
                                                <t t-esc="Math.round(progress_clamped || 0) + '%'"/>
                                            </t>
                                            <t t-else="">‚Äî</t>
                                        </text>
                                    </svg>
                                    <div class="sc-progress-caption">
                                        <span class="sc-progress-title" title="Ê†πÊçÆËøõÂ∫¶Â°´Êä•‰∏éËÆ°ÂàíÂè£ÂæÑÊ±áÊÄª">ÁªºÂêàÊâßË°åËøõÂ∫¶</span>
                                        <t t-if="has_plan_data">
                                            <br/>ËÆ°Âàí <t t-esc="Math.round(plan_rate_clamped)"/>%
                                        </t>
                                        <t t-elif="!has_progress_data">
                                            <br/>Êú™ÂàùÂßãÂåñ
                                        </t>
                                    </div>
                                </div>
                            </div>

                            <div class="sc-card-footer">
                                <div class="sc-footer-left">
                                    <div t-if="record.location.value">
                                        üìç <span t-esc="record.location.value"/>
                                    </div>
                                    <div t-if="record.contract_no.value">
                                        üìÑ ÂêàÂêåÔºö<span t-esc="record.contract_no.value"/>
                                    </div>
                                    <div t-if="doc_missing">
                                        ‚ö† ËµÑÊñôÁº∫Âè£ <t t-esc="doc_missing"/>/<t t-esc="doc_required or '-'"/>
                                    </div>
                                    <div t-if="progress_gap &lt; -5">
                                        ‚è≥ ËøõÂ∫¶È£éÈô©ÔºöËêΩÂêé <t t-esc="Math.abs(Math.round(progress_gap))"/>%
                                    </div>
                                </div>
                                <div class="sc-footer-right">
                                    <div class="sc-footer-row">
                                        <span class="sc-footer-label">ÂºÄÁ•®</span>
                                        <span class="sc-footer-value">
                                            <t t-if="has_finance_data">
                                                <t t-esc="record.dashboard_invoice_amount.value or '0.00'"/>
                                            </t>
                                            <t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                    <div class="sc-footer-row">
                                        <span class="sc-footer-label">Êî∂Ê¨æ</span>
                                        <span class="sc-footer-value">
                                            <t t-if="has_finance_data">
                                                <t t-esc="record.dashboard_payment_in.value or '0.00'"/>
                                            </t>
                                            <t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                    <div class="sc-footer-row">
                                        <span class="sc-footer-label">‰ªòÊ¨æ</span>
                                        <span class="sc-footer-value">
                                            <t t-if="has_finance_data">
                                                <t t-esc="record.dashboard_payment_out.value or '0.00'"/>
                                            </t>
                                            <t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                    <div class="sc-footer-row">
                                        <span class="sc-footer-label">ËµÑÊñô</span>
                                        <span class="sc-footer-value">
                                            <t t-if="doc_required">
                                                <t t-esc="Math.round(doc_rate_clamped || 0) + '%'"/>
                                            </t>
                                            <t t-else="">‚Äî</t>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="sc-card-more">Êõ¥Â§öË¥¢Âä°‰∏éËµÑÊñô</div>
                        </div>
                    </t>
                </templates>

                <style>
                    .sc_project_dashboard_kanban .sc_project_card{
                        border-radius: 10px;
                        box-shadow: 0 2px 6px rgba(0,0,0,.06);
                        padding: 8px 10px;
                        border-left: 4px solid #7159c1;
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                        min-height: 170px;
                        background: #fafafa;
                        border: 1px solid #eee;
                        position: relative;
                    }
                    .sc_project_dashboard_kanban .sc_project_card.sc_risk_high{
                        border-left-color: #e74c3c;
                    }
                    .sc_project_dashboard_kanban .sc_project_card.sc_risk_warn{
                        border-left-color: #f39c12;
                    }
                    .sc-card-header{
                        display:flex;
                        flex-direction: column;
                        gap:2px;
                    }
                    .sc-title-row{
                        display:flex;
                        justify-content:space-between;
                        align-items:baseline;
                        gap:6px;
                    }
                    .sc-project-name{
                        font-size:14px;
                        font-weight:600;
                        color:#303133;
                        flex:1 1 auto;
                    }
                    .sc-project-code{
                        font-size:11px;
                        color:#909399;
                        white-space:nowrap;
                    }
                    .sc-meta-row{
                        display:flex;
                        justify-content:space-between;
                        font-size:11px;
                        color:#666;
                    }
                    .sc-card-body{
                        display:flex;
                        justify-content:space-between;
                        gap:10px;
                    }
                    .sc-kpi-block{
                        flex:1 1 auto;
                        display:flex;
                        flex-direction:column;
                        gap:3px;
                        font-size:11px;
                    }
                    .sc-kpi-row{
                        display:flex;
                        justify-content:space-between;
                        align-items:center;
                    }
                    .sc-kpi-bold .sc-kpi-value{
                        font-weight:600;
                    }
                    .sc-kpi-label{
                        color:#666;
                    }
                    .sc-kpi-value{
                        color:#333;
                        font-weight:500;
                    }
                    .sc-progress-block{
                        width:80px;
                        display:flex;
                        flex-direction:column;
                        align-items:center;
                        font-size:10px;
                        color:#666;
                        text-align:center;
                    }
                    .sc-card-footer{
                        display:flex;
                        justify-content:space-between;
                        gap:8px;
                        border-top:1px solid #f0f0f0;
                        padding-top:4px;
                        font-size:10px;
                        color:#666;
                        max-height:0;
                        opacity:0;
                        overflow:hidden;
                        transition:max-height .2s ease, opacity .2s ease;
                    }
                    .sc-footer-right{
                        display:grid;
                        grid-template-columns:repeat(2, auto);
                        gap:2px 8px;
                    }
                    .sc-footer-row{
                        display:flex;
                        justify-content:space-between;
                    }
                    .sc-footer-label{
                        color:#999;
                        margin-right:2px;
                    }
                    .sc-footer-value{
                        font-weight:600;
                        color:#444;
                    }
                    .sc-badge-icon {
                        position: absolute;
                        top: 6px;
                        right: 6px;
                        font-size: 14px;
                    }
                    .sc-card-more{
                        font-size:10px;
                        color:#999;
                        text-align:right;
                    }
                    .sc_project_dashboard_kanban .sc_project_card:hover .sc-card-footer{
                        max-height:120px;
                        opacity:1;
                    }
                    .sc_project_dashboard_kanban .sc_project_card:hover .sc-card-more{
                        display:none;
                    }
                    .sc-progress-empty text.sc-progress-empty-text{
                        fill:#999;
                    }
                    .sc-group-count{
                        margin-left:4px;
                        color:#999;
                    }
                </style>
            </kanban>
        </field>
    </record>

    <record id="action_project_dashboard" model="ir.actions.act_window">
        <field name="name">È°πÁõÆÈ©æÈ©∂Ëà±</field>
        <field name="res_model">project.project</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_id" ref="view_project_project_kanban_dashboard"/>
        <field name="context">{'group_by': 'stage_id'}</field>
        <field name="domain">[('sc_demo_showcase_ready', '=', True)]</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_project_read'))]"/>
    </record>
</odoo>
