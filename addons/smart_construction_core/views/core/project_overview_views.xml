<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- 概览页白名单：仅显示核心身份字段 + 生命周期/摘要/下一步，禁止扩展字段 -->
    <record id="view_project_overview_form" model="ir.ui.view">
        <field name="name">project.project.form.sc.overview</field>
        <field name="model">project.project</field>
        <field name="arch" type="xml">
            <form string="项目概览" create="0" edit="0" delete="0" duplicate="0">
                <sheet>
                    <div class="sc-project-overview">
                        <div class="sc-project-overview__header d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <div class="sc-project-title h3 mb-1">
                                    <field name="name" readonly="1"/>
                                </div>
                                <div class="text-muted">你是：项目负责人 <field name="user_id" readonly="1"/></div>
                                <div class="text-muted">项目经理 <field name="manager_id" readonly="1"/></div>
                                <div class="small text-muted mt-1">
                                    业主 <field name="owner_id" readonly="1"/>
                                    · 类型 <field name="project_type_id" readonly="1"/>
                                </div>
                                <field name="location" readonly="1" invisible="1"/>
                            </div>
                            <button type="action"
                                    name="%(smart_construction_core.action_sc_project_manage)d"
                                    string="项目设置"
                                    class="btn btn-link"
                                    groups="smart_construction_core.group_sc_cap_project_manager,smart_construction_core.group_sc_super_admin"/>
                        </div>

                        <div class="sc-project-stage mb-3">
                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <div class="sc-project-stage__label">当前阶段：<field name="lifecycle_state" readonly="1"/></div>
                                <div class="d-flex flex-wrap gap-2">
                                    <button name="%(smart_construction_core.action_sc_project_manage)d"
                                            type="action"
                                            string="去补齐资料"
                                            class="btn btn-outline-primary"
                                            invisible="lifecycle_state != 'draft' or (sc_stage_required_done == sc_stage_required_total)"/>
                                    <button name="action_sc_submit"
                                            type="object"
                                            string="进入下一阶段"
                                            class="btn btn-primary"
                                            invisible="lifecycle_state != 'draft' or sc_stage_required_done &lt; sc_stage_required_total"/>
                                    <button name="action_view_stage_requirements"
                                            type="object"
                                            string="查看阶段要求"
                                            class="btn btn-primary"
                                            invisible="lifecycle_state == 'draft'"/>
                                </div>
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'draft'">
                                立项完成度：
                                <field name="sc_stage_required_done" readonly="1" nolabel="1"/>
                                /
                                <field name="sc_stage_required_total" readonly="1" nolabel="1"/>
                            </div>
                            <div class="sc-project-stage__req" invisible="lifecycle_state != 'draft'">
                                <div class="text-muted mb-1">要进入下一阶段，你还差：</div>
                                <widget name="sc_stage_requirements" options="{'limit': 3}"/>
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'in_progress'">
                                施工推进中，优先处理待办与关键风险。
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'paused'">
                                项目已暂停，需明确原因并评估恢复条件。
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'done'">
                                项目已完成，准备结算与归档。
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'closing'">
                                进入结算阶段，请核对合同与成本。
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'warranty'">
                                保修期内，关注问题闭环与客户反馈。
                            </div>
                            <div class="sc-project-stage__desc text-muted mt-2" invisible="lifecycle_state != 'closed'">
                                项目已归档，历史数据只读。
                            </div>
                        </div>

                        <div class="sc-project-next mb-4">
                            <div class="sc-project-next__title">你现在最该做的事</div>
                            <widget name="sc_next_actions" options="{'limit': 3}"/>
                        </div>

                        <div class="sc-project-cards">
                            <div class="sc-project-cards__title">项目当前状态（概览）</div>
                            <div class="row g-2">
                                <div class="col-12 col-md-6 col-lg-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="fw-bold">合同</div>
                                            <div class="text-muted" invisible="sc_overview_contract_count != 0">
                                                尚未建立合同
                                            </div>
                                            <div class="text-muted" invisible="sc_overview_contract_count == 0">
                                                已有 <field name="sc_overview_contract_count" readonly="1" nolabel="1"/> 份合同
                                            </div>
                                            <button type="action"
                                                    name="%(smart_construction_core.action_construction_contract_my)d"
                                                    string="查看合同"
                                                    class="btn btn-link px-0"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 col-lg-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="fw-bold">成本</div>
                                            <div class="text-muted" invisible="sc_overview_cost_count != 0">
                                                尚未录入成本
                                            </div>
                                            <div class="text-muted" invisible="sc_overview_cost_count == 0">
                                                已录入 <field name="sc_overview_cost_count" readonly="1" nolabel="1"/> 条
                                            </div>
                                            <button type="action"
                                                    name="%(smart_construction_core.action_project_cost_ledger_my)d"
                                                    string="查看成本"
                                                    class="btn btn-link px-0"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 col-lg-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="fw-bold">财务</div>
                                            <div class="text-muted" invisible="sc_overview_payment_pending_count == 0">
                                                ⚠ 有待审批付款 <field name="sc_overview_payment_pending_count" readonly="1" nolabel="1"/> 笔
                                            </div>
                                            <div class="text-muted" invisible="sc_overview_payment_pending_count != 0">
                                                当前无待审批付款
                                            </div>
                                            <button type="action"
                                                    name="%(smart_construction_core.action_payment_request_my)d"
                                                    string="查看财务"
                                                    class="btn btn-link px-0"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6 col-lg-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="fw-bold">项目任务</div>
                                            <div class="text-muted" invisible="sc_overview_task_in_progress_count == 0">
                                                进行中任务 <field name="sc_overview_task_in_progress_count" readonly="1" nolabel="1"/> 项
                                            </div>
                                            <div class="text-muted" invisible="sc_overview_task_in_progress_count != 0">
                                                当前无进行中任务
                                            </div>
                                            <button type="object"
                                                    name="action_view_my_tasks"
                                                    string="查看任务"
                                                    class="btn btn-link px-0"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </sheet>
            </form>
        </field>
    </record>
</odoo>
