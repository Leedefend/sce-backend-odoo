<odoo>
    <!-- ===== 项目预算 ===== -->
    <record id="view_project_budget_tree" model="ir.ui.view">
        <field name="name">project.budget.tree</field>
        <field name="model">project.budget</field>
        <field name="arch" type="xml">
            <tree decoration-danger="margin_rate_target &lt; 0">
                <field name="name"/>
                <field name="project_id"/>
                <field name="contract_id"/>
                <field name="version"/>
                <field name="version_date"/>
                <field name="amount_revenue_target"/>
                <field name="amount_cost_target"/>
                <field name="margin_target"/>
                <field name="margin_rate_target"/>
                <field name="is_active"/>
            </tree>
        </field>
    </record>

    <record id="view_project_budget_form" model="ir.ui.view">
        <field name="name">project.budget.form</field>
        <field name="model">project.budget</field>
        <field name="arch" type="xml">
            <form string="项目预算">
                <header>
                    <button name="action_set_active" type="object" string="设为当前"
                            class="oe_highlight"
                            modifiers="{'invisible': [['is_active','=',True]]}" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <button name="action_archive_version" type="object" string="停用"
                            modifiers="{'invisible': [['is_active','=',False]]}" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <button name="action_copy_version" type="object" string="复制并保留分摊"
                            class="btn-secondary" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <button name="action_copy_version" type="object" string="复制不带分摊"
                            class="btn-secondary"
                            context="{'copy_allocations': False}" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <field name="is_active"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="project_id" required="1"/>
                            <field name="contract_id"/>
                            <field name="version"/>
                            <field name="version_date"/>
                            <field name="is_active"/>
                        </group>
                        <group>
                            <field name="amount_revenue_target"/>
                            <field name="amount_cost_target"/>
                            <field name="margin_target" readonly="1"/>
                            <field name="margin_rate_target" readonly="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="预算清单">
                            <field name="line_ids">
                                <tree editable="bottom">
                                    <field name="sequence"/>
                                    <field name="boq_code"/>
                                    <field name="name"/>
                                    <field name="wbs_id"/>
                                    <field name="qty_bidded"/>
                                    <field name="uom_id"/>
                                    <field name="price_bidded"/>
                                    <field name="amount_bidded"/>
                                    <field name="measure_rule"/>
                                    <field name="revenue_recognition"/>
                                    <field name="alloc_ids" widget="one2many_list" readonly="1"/>
                                </tree>
                            </field>
                        </page>
                        <page string="说明">
                            <field name="note"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_project_budget_search" model="ir.ui.view">
        <field name="name">project.budget.search</field>
        <field name="model">project.budget</field>
        <field name="arch" type="xml">
            <search string="项目预算">
                <field name="project_id"/>
                <field name="contract_id"/>
                <filter string="仅当前生效" name="filter_active" domain="[('is_active', '=', True)]"/>
                <filter string="含停用" name="filter_inactive" domain="[('is_active', '=', False)]"/>
                <group expand="1" string="分组">
                    <filter string="按项目" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="按合同" name="group_contract" context="{'group_by': 'contract_id'}"/>
                    <filter string="按版本日期" name="group_version_date" context="{'group_by': 'version_date'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="view_project_budget_graph" model="ir.ui.view">
        <field name="name">project.budget.graph</field>
        <field name="model">project.budget</field>
        <field name="arch" type="xml">
            <graph string="预算目标" stacked="True">
                <field name="amount_cost_target" type="measure"/>
                <field name="amount_revenue_target" type="measure"/>
                <field name="project_id" type="row"/>
            </graph>
        </field>
    </record>

    <record id="action_project_budget" model="ir.actions.act_window">
        <field name="name">项目预算</field>
        <field name="res_model">project.budget</field>
        <field name="view_mode">tree,form,graph</field>
        <field name="context">{'search_default_group_by_project': 1}</field>
        <field name="search_view_id" ref="view_project_budget_search"/>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read'))]"/>
    </record>

    <!-- ===== 成本科目 ===== -->
    <record id="view_project_cost_code_tree" model="ir.ui.view">
        <field name="name">project.cost.code.tree</field>
        <field name="model">project.cost.code</field>
        <field name="arch" type="xml">
            <tree editable="bottom">
                <field name="code"/>
                <field name="name"/>
                <field name="parent_id"/>
                <field name="type"/>
                <field name="level"/>
                <field name="active"/>
                <field name="note"/>
            </tree>
        </field>
    </record>

    <record id="view_project_cost_code_form" model="ir.ui.view">
        <field name="name">project.cost.code.form</field>
        <field name="model">project.cost.code</field>
        <field name="arch" type="xml">
            <form string="成本科目">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="code"/>
                        <field name="parent_id"/>
                        <field name="type"/>
                        <field name="level"/>
                        <field name="active"/>
                        <field name="note"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_project_cost_code" model="ir.actions.act_window">
        <field name="name">成本科目</field>
        <field name="res_model">project.cost.code</field>
        <field name="view_mode">tree,form</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_config_admin'))]"/>
    </record>

    <!-- ===== 预算 vs 实际 报表 ===== -->
    <record id="view_project_cost_compare_tree" model="ir.ui.view">
        <field name="name">project.cost.compare.tree</field>
        <field name="model">project.cost.compare</field>
        <field name="arch" type="xml">
            <tree string="项目成本预算 vs 实际" default_order="project_id asc, period asc, wbs_id asc, cost_code_id asc">
                <field name="project_id"/>
                <field name="period"/>
                <field name="wbs_id"/>
                <field name="cost_code_id" options="{'no_open': False}"/>
                <field name="budget_amount" sum="预算合计"/>
                <field name="actual_amount" sum="实际合计"/>
                <field name="diff_amount" sum="差额合计"/>
                <field name="diff_rate"
                       decoration-danger="diff_rate &lt; -10"
                       decoration-warning="diff_rate &lt; 0"
                       decoration-success="diff_rate &gt;= 0"/>
                <button name="action_open_ledger"
                        type="object"
                        class="oe_link"
                        string="查看台账"/>
            </tree>
        </field>
    </record>

    <record id="view_project_cost_compare_pivot" model="ir.ui.view">
        <field name="name">project.cost.compare.pivot</field>
        <field name="model">project.cost.compare</field>
        <field name="arch" type="xml">
            <pivot string="项目成本预算 vs 实际">
                <field name="project_id" type="row"/>
                <field name="period" type="row"/>
                <field name="wbs_id" type="row"/>
                <field name="cost_code_id" type="row"/>
                <field name="budget_amount" type="measure"/>
                <field name="actual_amount" type="measure"/>
                <field name="diff_amount" type="measure"/>
                <field name="diff_rate" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="action_project_cost_compare" model="ir.actions.act_window">
        <field name="name">项目成本预算 vs 实际</field>
        <field name="res_model">project.cost.compare</field>
        <field name="view_mode">tree,pivot</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read'))]"/>
    </record>

    <!-- ===== 项目经营利润 ===== -->
    <record id="view_project_profit_compare_tree" model="ir.ui.view">
        <field name="name">project.profit.compare.tree</field>
        <field name="model">project.profit.compare</field>
        <field name="arch" type="xml">
            <tree string="项目经营利润" default_order="project_id asc, period asc, wbs_id asc">
                <field name="project_id"/>
                <field name="period"/>
                <field name="wbs_id"/>
                <field name="revenue_budget_amount" sum="预算收入合计"/>
                <field name="revenue_actual_amount" sum="实际收入合计"/>
                <field name="cost_budget_amount" sum="预算成本合计"/>
                <field name="cost_actual_amount" sum="实际成本合计"/>
                <field name="gross_profit_actual" sum="实际毛利合计"/>
                <field name="gross_margin_rate"
                       decoration-danger="gross_margin_rate &lt; 0"
                       decoration-warning="gross_margin_rate &lt; 10"
                       decoration-success="gross_margin_rate &gt;= 10"/>
            </tree>
        </field>
    </record>

    <record id="view_project_profit_compare_pivot" model="ir.ui.view">
        <field name="name">project.profit.compare.pivot</field>
        <field name="model">project.profit.compare</field>
        <field name="arch" type="xml">
            <pivot string="项目经营利润">
                <field name="project_id" type="row"/>
                <field name="period" type="row"/>
                <field name="wbs_id" type="row"/>
                <field name="revenue_budget_amount" type="measure"/>
                <field name="revenue_actual_amount" type="measure"/>
                <field name="cost_budget_amount" type="measure"/>
                <field name="cost_actual_amount" type="measure"/>
                <field name="gross_profit_actual" type="measure"/>
                <field name="gross_profit_budget" type="measure"/>
                <field name="gross_margin_rate" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="action_project_profit_compare" model="ir.actions.act_window">
        <field name="name">项目经营利润</field>
        <field name="res_model">project.profit.compare</field>
        <field name="view_mode">tree,pivot</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read'))]"/>
    </record>

    <!-- ===== 成本台账 ===== -->
    <record id="view_project_cost_ledger_tree" model="ir.ui.view">
        <field name="name">project.cost.ledger.tree</field>
        <field name="model">project.cost.ledger</field>
        <field name="arch" type="xml">
            <tree string="成本台账">
                <field name="date"/>
                <field name="project_id"/>
                <field name="cost_code_id"/>
                <field name="amount"/>
                <field name="wbs_id"/>
                <field name="period"/>
                <field name="partner_id"/>
                <field name="note"/>
            </tree>
        </field>
    </record>

    <record id="view_project_cost_ledger_form" model="ir.ui.view">
        <field name="name">project.cost.ledger.form</field>
        <field name="model">project.cost.ledger</field>
        <field name="arch" type="xml">
            <form string="成本台账">
                <sheet>
                    <group>
                        <group>
                            <field name="project_id"/>
                            <field name="date"/>
                            <field name="period" readonly="1"/>
                            <field name="wbs_id"/>
                            <field name="cost_code_id"/>
                        </group>
                        <group>
                            <field name="qty"/>
                            <field name="uom_id"/>
                            <field name="amount"/>
                            <field name="partner_id"/>
                        </group>
                    </group>
                    <group>
                        <group string="系统来源（只读）" modifiers="{'invisible': [['source_model','=',False]]}">
                            <field name="source_model" readonly="1"/>
                            <field name="source_id" readonly="1"/>
                            <field name="source_line_id" readonly="1"/>
                        </group>
                        <field name="note"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_project_cost_ledger_search" model="ir.ui.view">
        <field name="name">project.cost.ledger.search</field>
        <field name="model">project.cost.ledger</field>
        <field name="arch" type="xml">
            <search string="成本台账">
                <field name="project_id"/>
                <field name="cost_code_id"/>
                <field name="wbs_id"/>
                <field name="partner_id"/>
                <filter string="本月" name="filter_current_month" domain="[('period', '=', context_today().strftime('%Y-%m'))]"/>
                <group expand="1" string="分组">
                    <filter string="按项目" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="按科目" name="group_cost" context="{'group_by': 'cost_code_id'}"/>
                    <filter string="按WBS" name="group_wbs" context="{'group_by': 'wbs_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_project_cost_ledger" model="ir.actions.act_window">
        <field name="name">成本台账</field>
        <field name="res_model">project.cost.ledger</field>
        <field name="view_mode">tree,form,pivot,graph</field>
        <field name="search_view_id" ref="view_project_cost_ledger_search"/>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read'))]"/>
    </record>

    <record id="action_project_cost_ledger_my" model="ir.actions.act_window">
        <field name="name">我的成本台账</field>
        <field name="res_model">project.cost.ledger</field>
        <field name="view_mode">tree,form,pivot,graph</field>
        <field name="domain">['|', ('project_id.user_id', '=', uid), ('project_id.manager_id', '=', uid)]</field>
        <field name="search_view_id" ref="view_project_cost_ledger_search"/>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read'))]"/>
    </record>

    <record id="view_project_cost_ledger_pivot" model="ir.ui.view">
        <field name="name">project.cost.ledger.pivot</field>
        <field name="model">project.cost.ledger</field>
        <field name="arch" type="xml">
            <pivot string="成本台账分析">
                <field name="amount" type="measure"/>
                <field name="project_id" type="row"/>
                <field name="cost_code_id" type="col"/>
                <field name="wbs_id" type="row"/>
                <field name="partner_id" type="col"/>
            </pivot>
        </field>
    </record>

    <record id="view_project_cost_ledger_graph" model="ir.ui.view">
        <field name="name">project.cost.ledger.graph</field>
        <field name="model">project.cost.ledger</field>
        <field name="arch" type="xml">
            <graph string="成本趋势" stacked="True">
                <field name="amount" type="measure"/>
                <field name="project_id" type="row"/>
                <field name="cost_code_id" type="col"/>
            </graph>
        </field>
    </record>

    <!-- ===== 预算清单分摊 ===== -->
    <record id="view_project_budget_cost_alloc_tree" model="ir.ui.view">
        <field name="name">project.budget.cost.alloc.tree</field>
        <field name="model">project.budget.cost.alloc</field>
        <field name="arch" type="xml">
            <tree>
                <field name="project_id"/>
                <field name="budget_boq_line_id"/>
                <field name="cost_code_id"/>
                <field name="ratio"/>
                <field name="amount_budget"/>
                <field name="note"/>
            </tree>
        </field>
    </record>

    <record id="view_project_budget_cost_alloc_form" model="ir.ui.view">
        <field name="name">project.budget.cost.alloc.form</field>
        <field name="model">project.budget.cost.alloc</field>
        <field name="arch" type="xml">
            <form string="预算清单成本分摊">
                <sheet>
                    <group>
                        <field name="project_id" readonly="1"/>
                        <field name="budget_boq_line_id" required="1"/>
                        <field name="cost_code_id" required="1"/>
                        <field name="ratio"/>
                        <field name="amount_budget"/>
                        <field name="note"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_project_budget_cost_alloc" model="ir.actions.act_window">
        <field name="name">预算清单分摊</field>
        <field name="res_model">project.budget.cost.alloc</field>
        <field name="view_mode">tree,form</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read')),(4, ref('smart_construction_core.group_sc_cap_cost_user')),(4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
    </record>

    <!-- ===== 工程结构树（WBS） ===== -->
    <record id="view_project_wbs_tree" model="ir.ui.view">
        <field name="name">construction.work.breakdown.tree</field>
        <field name="model">construction.work.breakdown</field>
        <field name="arch" type="xml">
            <tree>
                <field name="sequence" widget="handle"/>
                <field name="company_id" invisible="1"/>
                <field name="project_id"/>
                <field name="code"/>
                <field name="name"/>
                <field name="parent_id"/>
                <field name="level_type"/>
                <field name="level"/>
                <field name="boq_amount_total" sum="清单金额合计"/>
            </tree>
        </field>
    </record>

    <record id="view_project_wbs_form" model="ir.ui.view">
        <field name="name">construction.work.breakdown.form</field>
        <field name="model">construction.work.breakdown</field>
        <field name="priority" eval="20"/>
        <field name="arch" type="xml">
            <form string="工程结构">
                <sheet>
                    <group>
                        <field name="company_id" invisible="1"/>
                        <field name="project_id" required="1" domain="[]"/>
                        <field name="sequence"/>
                        <field name="code"/>
                        <field name="name" required="1"/>
                        <field name="parent_id"/>
                        <field name="level_type"/>
                        <field name="level" readonly="1"/>
                    </group>
                    <notebook>
                        <page string="清单">
                            <field name="boq_line_ids" context="{'default_project_id': project_id, 'default_work_id': id}">
                                <tree editable="bottom">
                                    <field name="code"/>
                                    <field name="name"/>
                                    <field name="quantity"/>
                                    <field name="price"/>
                                    <field name="amount"/>
                                </tree>
                            </field>
                        </page>
                        <page string="任务">
                            <field name="task_ids" context="{'default_project_id': project_id, 'default_work_id': id}">
                                <tree editable="bottom">
                                    <field name="company_id" invisible="1"/>
                                    <field name="project_id" invisible="1"/>
                                    <field name="name"/>
                                    <field name="user_ids"/>
                                    <field name="date_deadline"/>
                                    <field name="stage_id"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_project_wbs_search" model="ir.ui.view">
        <field name="name">construction.work.breakdown.search</field>
        <field name="model">construction.work.breakdown</field>
        <field name="arch" type="xml">
            <search string="工程结构">
                <field name="project_id"/>
                <field name="parent_id"/>
                <filter string="顶级节点" name="filter_root" domain="[('parent_id','=',False)]"/>
                <group expand="1" string="分组">
                    <filter string="按项目" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="按层级" name="group_level" context="{'group_by': 'level_type'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_project_wbs" model="ir.actions.act_window">
        <field name="name">工程结构</field>
        <field name="res_model">construction.work.breakdown</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_project_wbs_search"/>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_project_user')), (4, ref('smart_construction_core.group_sc_cap_project_manager'))]"/>
    </record>

    <!-- ===== 进度计量 ===== -->
    <record id="view_project_progress_entry_tree" model="ir.ui.view">
        <field name="name">project.progress.entry.tree</field>
        <field name="model">project.progress.entry</field>
        <field name="arch" type="xml">
            <tree>
                <field name="date"/>
                <field name="project_id"/>
                <field name="wbs_id"/>
                <field name="progress_rate"/>
                <field name="qty_done"/>
                <field name="qty_cum"/>
                <field name="note"/>
            </tree>
        </field>
    </record>

    <record id="view_project_progress_entry_form" model="ir.ui.view">
        <field name="name">project.progress.entry.form</field>
        <field name="model">project.progress.entry</field>
        <field name="arch" type="xml">
            <form string="进度计量">
                <sheet>
                    <group>
                        <field name="project_id" required="1"/>
                        <field name="wbs_id" required="1" domain="[('project_id','=',project_id)]"/>
                        <field name="date"/>
                    </group>
                    <group>
                        <field name="qty_done"/>
                        <field name="qty_cum"/>
                        <field name="progress_rate"
                               placeholder="0-100（%）"
                               widget="percentage"/>
                    </group>
                    <group>
                        <label for="progress_rate" string="录入口径" class="o_form_label text-muted"/>
                        <div class="text-muted o_mt8">
                            累计完成比例（0–100）。例如 35 表示 35%。
                            <span class="text-danger o_mt4"
                                  modifiers="{'invisible': ['|', ('progress_rate','=', False), '&amp;', ('progress_rate','&gt;=',0), ('progress_rate','&lt;=',100)]}">
                                ⚠ 数值超出 0-100，可能录入异常，请确认。
                            </span>
                        </div>
                    </group>
                    <group>
                        <field name="note"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_project_progress_entry" model="ir.actions.act_window">
        <field name="name">进度计量</field>
        <field name="res_model">project.progress.entry</field>
        <field name="view_mode">tree,form</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_read'))]"/>
    </record>
</odoo>
