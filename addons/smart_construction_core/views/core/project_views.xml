<odoo>
    <record id="action_project_budget_quick" model="ir.actions.act_window">
        <field name="name">项目预算</field>
        <field name="res_model">project.budget</field>
        <field name="view_mode">tree,form,graph</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_user')), (4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
    </record>

    <record id="action_project_cost_ledger_quick" model="ir.actions.act_window">
        <field name="name">成本台账</field>
        <field name="res_model">project.cost.ledger</field>
        <field name="view_mode">tree,form,pivot,graph</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_user')), (4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
        <field name="context">{'default_project_id': context.get('active_id'), 'search_default_project_id': context.get('active_id')}</field>
        <field name="domain">context.get('default_project_id') and [('project_id','=',context.get('default_project_id'))] or []</field>
    </record>

    <record id="action_project_progress_quick" model="ir.actions.act_window">
        <field name="name">进度计量</field>
        <field name="res_model">project.progress.entry</field>
        <field name="view_mode">tree,form</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_user')), (4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
    </record>

    <record id="action_project_contract_overview" model="ir.actions.act_window">
        <field name="name">项目合同汇总</field>
        <field name="res_model">construction.contract</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'searchpanel_default_project_id': True}</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_contract_user')), (4, ref('smart_construction_core.group_sc_cap_contract_manager'))]"/>
    </record>

    <record id="view_project_my_list_tree" model="ir.ui.view">
        <field name="name">project.project.tree.sc.my.list</field>
        <field name="model">project.project</field>
        <field name="arch" type="xml">
            <tree string="我的项目">
                <field name="name"/>
                <field name="manager_id"/>
                <field name="owner_id"/>
                <field name="lifecycle_state"/>
                <field name="write_date"/>
            </tree>
        </field>
    </record>

    <record id="view_project_project_search_my" model="ir.ui.view">
        <field name="name">project.project.search.sc.my</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.view_project_project_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <filter name="filter_my_projects"
                        string="我的项目"
                        domain="['|', ('manager_id', '=', uid), '|', ('owner_id', '=', uid), ('user_id', '=', uid)]"/>
                <filter name="filter_draft"
                        string="草稿"
                        domain="[('lifecycle_state', '=', 'draft')]"/>
                <filter name="filter_in_progress"
                        string="进行中"
                        domain="[('lifecycle_state', '=', 'in_progress')]"/>
            </xpath>
        </field>
    </record>

    <!-- 项目表单扩展：施工信息 + 工程资料 + 合同 -->
    <record id="view_project_form_sc_core" model="ir.ui.view">
        <field name="name">project.project.form.sc.core</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="arch" type="xml">

            <!-- 顶部状态栏：使用生命周期字段，避免任务态混入 -->
            <xpath expr="//form/header//field[@name='stage_id']" position="replace">
                <field name="lifecycle_state"
                       widget="statusbar"
                       statusbar_visible="draft,in_progress,paused,done,closing,warranty,closed"/>
            </xpath>
            <xpath expr="//form/header" position="inside">
                <button name="action_sc_submit"
                        type="object"
                        string="提交立项"
                        class="btn-primary"
                        invisible="lifecycle_state != 'draft'"/>
            </xpath>

            <!-- 重做按钮区：仅保留主流程按钮 -->
            <xpath expr="//sheet/div[@name='button_box']" position="replace">
                <div class="oe_button_box" name="button_box">
                    <button name="action_view_tasks" string="任务" type="object" class="oe_stat_button"
                            groups="base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin">
                        <field string="Tasks" name="open_task_count" widget="statinfo"/>
                    </button>
                    <button name="project_update_all_action" type="object" class="oe_stat_button"
                            groups="base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin">
                        <field name="last_update_color" invisible="1"/>
                        <div class="o_stat_info">
                            <field name="last_update_status" readonly="1" widget="status_with_color"
                                   status_label="Project Status"/>
                        </div>
                    </button>
                    <button name="action_open_wbs" string="执行结构" type="object" class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_project_read"/>
                    <button name="action_open_boq_import" string="工程量清单" type="object" class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <button name="%(smart_construction_core.action_project_budget_quick)d"
                            string="预算/成本"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"
                            context="{'default_project_id': id, 'search_default_project_id': id}"/>
                    <button name="%(smart_construction_core.action_project_contract_overview)d"
                            string="合同"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_contract_user,smart_construction_core.group_sc_cap_contract_manager"
                            context="{'search_default_project_id': [id], 'default_project_id': id}"/>
                    <button name="%(smart_construction_core.action_project_material_plan)d"
                            string="物资/采购"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_material_user,smart_construction_core.group_sc_cap_material_manager"
                            context="{'search_default_project_id': [id], 'default_project_id': id}"/>
                    <button name="%(smart_construction_core.action_sc_finance_dashboard)d"
                            string="结算/财务"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_finance_user,smart_construction_core.group_sc_cap_finance_manager"
                            context="{'search_default_project_id': [id], 'default_project_id': id}"/>
                </div>
            </xpath>

            <xpath expr="//sheet/*[1]" position="before">
                <div class="alert alert-info" role="alert" invisible="lifecycle_state != 'draft'">
                    当前为草稿，系统将自动保存你的修改；提交（立项）时才会进行完整校验。
                </div>
            </xpath>

            <xpath expr="//sheet/div[@name='button_box']" position="after">
                <widget name="sc_insight_banner"
                        options="{'scene': 'project.entry'}"
                        invisible="lifecycle_state == 'draft'"/>
            </xpath>

            <!-- 概览/施工/协作页插入到原生 notebook 开头 -->
            <xpath expr="//sheet/notebook/page[1]" position="before">
                <page string="投标管理" name="sc_tender" data-tab="sc_tender" groups="smart_construction_core.group_sc_cap_project_user">
                    <field name="tender_bid_ids" context="{'default_project_id': id, 'default_state': 'prepare'}">
                        <tree string="投标记录" editable="bottom">
                            <field name="tender_name"/>
                            <field name="tender_round"/>
                            <field name="owner_id"/>
                            <field name="bid_amount"/>
                            <field name="amount_total"/>
                            <field name="state"/>
                            <field name="deadline"/>
                        </tree>
                    </field>
                </page>
                <page string="施工信息" name="sc_construction" groups="smart_construction_core.group_sc_cap_project_read">
                    <group col="4" string="施工项目信息" data-sc-anchor="schedule">
                        <field name="project_code" readonly="1"/>
                        <field name="project_type_id"/>
                        <field name="project_category_id"/>
                        <field name="lifecycle_state"/>
                        <field name="phase_key" invisible="1"/>
                        <field name="owner_contact"/>
                        <field name="location"/>
                        <field name="contract_no"/>
                        <field name="start_date"/>
                        <field name="end_date"/>
                    </group>
                    <group col="4" string="项目责任人" data-sc-anchor="manager">
                        <field name="manager_id"/>
                        <field name="cost_manager_id"/>
                        <field name="doc_manager_id"/>
                    </group>
                    <group string="职责分工">
                        <field name="responsibility_ids">
                            <tree editable="bottom">
                                <field name="role_key"/>
                                <field name="user_id"/>
                                <field name="note"/>
                            </tree>
                        </field>
                    </group>
                    <group col="4" string="成本与进度" groups="smart_construction_core.group_sc_cap_cost_read">
                        <field name="budget_active_id" readonly="1" options="{'no_create': True}"/>
                        <field name="budget_active_cost_target" readonly="1"/>
                        <field name="budget_active_revenue_target" readonly="1"/>
                        <field name="cost_ledger_amount_actual" readonly="1"/>
                        <field name="cost_budget_gap" readonly="1"/>
                        <field name="progress_rate_latest" readonly="1"/>
                        <field name="progress_entry_count" readonly="1"/>
                        <button name="action_open_cost_ledger"
                                string="查看台账明细"
                                type="object"
                                class="btn-secondary"
                                groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                        <button name="action_open_progress_entries"
                                string="查看进度明细"
                                type="object"
                                class="btn-secondary"
                                groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    </group>
                </page>
            </xpath>

            <!-- notebook 中重排业务页签，保证系统/描述/设置靠后 -->
            <xpath expr="//sheet/notebook/page[@name='sc_construction']" position="after">
                <page string="WBS结构" name="wbs_tab" data-sc-anchor="wbs" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager">
                    <field name="wbs_ids" context="{'default_project_id': id}">
                        <tree editable="bottom">
                            <field name="sequence"/>
                            <field name="code"/>
                            <field name="name"/>
                            <field name="parent_id"/>
                            <field name="level"/>
                            <field name="active"/>
                        </tree>
                    </field>
                </page>
                <page string="工程量清单" name="boq_tab" data-sc-anchor="boq" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager">
                    <group col="2">
                        <group string="清单操作">
                            <button string="导入清单"
                                    type="object"
                                    class="oe_highlight"
                                    name="action_open_boq_import"
                                    groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                            <button string="生成工程结构"
                                    type="object"
                                    class="btn-secondary"
                                    name="action_generate_wbs_from_boq"
                                    groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                            <button string="生成施工任务"
                                    type="action"
                                    class="btn-secondary"
                                    name="%(smart_construction_core.action_project_task_from_boq_wizard)d"
                                    groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                            <button string="工程量清单分析"
                                    type="action"
                                    class="btn-secondary"
                                    name="%(smart_construction_core.action_project_boq_line_analysis)d"
                                    groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"
                                    context="{'search_default_project_id': [id]}"/>
                        </group>
                        <group string="维护" groups="smart_construction_core.group_sc_cap_cost_manager">
                            <button string="重建工程量清单层级"
                                    type="object"
                                    class="btn-secondary"
                                    name="action_rebuild_boq_hierarchy"
                                    groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                            <button string="校验工程量清单"
                                    type="object"
                                    class="btn-secondary"
                                    name="action_validate_boq"
                                    groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                        </group>
                    </group>
                    <group string="清单汇总">
                        <field name="boq_amount_total" readonly="1"/>
                        <field name="boq_amount_building" readonly="1"/>
                        <field name="boq_amount_installation" readonly="1"/>
                    </group>
                    <field name="boq_line_ids" context="{'default_project_id': id}">
                        <tree editable="bottom">
                            <field name="section_type"/>
                            <field name="category"/>
                            <field name="is_provisional"/>
                            <field name="source_type"/>
                            <field name="version"/>
                            <field name="sequence"/>
                            <field name="code"/>
                            <field name="name"/>
                            <field name="single_name"/>
                            <field name="unit_name"/>
                            <field name="spec"/>
                            <field name="uom_id"/>
                            <field name="quantity" sum="工程量合计"/>
                            <field name="price"/>
                            <field name="amount" readonly="1"/>
                            <field name="amount_leaf" sum="清单金额合计" optional="hide"/>
                            <field name="cost_item_id"/>
                            <field name="remark"/>
                            <field name="structure_id" readonly="1"/>
                        </tree>
                        <form string="工程量清单">
                            <group>
                                <field name="sequence"/>
                                <field name="code"/>
                                <field name="name"/>
                                <field name="spec"/>
                                <field name="uom_id"/>
                                <field name="quantity"/>
                                <field name="price"/>
                                <field name="amount" readonly="1"/>
                                <field name="cost_item_id"/>
                                <field name="remark"/>
                                <field name="source_type"/>
                                <field name="version"/>
                                <field name="structure_id" readonly="1"/>
                                <field name="task_id" readonly="1"/>
                            </group>
                        </form>
                    </field>
                </page>
                <page string="工程结构" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager">
                    <field name="work_ids" context="{'default_project_id': id}" domain="[('project_id','=',id)]">
                        <tree editable="bottom">
                            <field name="sequence" widget="handle"/>
                            <field name="level_type"/>
                            <field name="code"/>
                            <field name="name"/>
                            <field name="parent_id"/>
                            <field name="boq_quantity_total"/>
                            <field name="boq_amount_total"/>
                        </tree>
                    </field>
                    <group string="工程结构（WBS自动生成）">
                        <field name="structure_ids" context="{'default_project_id': id}">
                            <tree string="工程结构" editable="bottom">
                                <field name="structure_type"/>
                                <field name="code"/>
                                <field name="name"/>
                                <field name="level" readonly="1"/>
                                <field name="qty_total" readonly="1"/>
                                <field name="amount_total" readonly="1"/>
                                <field name="sequence"/>
                            </tree>
                            <form string="工程结构">
                                <sheet>
                                    <group>
                                        <field name="structure_type"/>
                                        <field name="code"/>
                                        <field name="name"/>
                                        <field name="parent_id"/>
                                        <field name="level" readonly="1"/>
                                        <field name="sequence"/>
                                    </group>
                                    <group string="挂接清单" colspan="2">
                                        <field name="boq_line_ids" readonly="1">
                                            <tree>
                                                <field name="code"/>
                                                <field name="name"/>
                                                <field name="quantity"/>
                                                <field name="uom_id"/>
                                                <field name="amount"/>
                                            </tree>
                                        </field>
                                    </group>
                                </sheet>
                            </form>
                        </field>
                    </group>
                </page>
                <page string="合同" name="sc_contract" data-tab="sc_contract" groups="smart_construction_core.group_sc_cap_contract_read">
                    <group>
                        <field name="contract_count" readonly="1"/>
                        <field name="contract_income_total" readonly="1"/>
                        <field name="contract_expense_total" readonly="1"/>
                    </group>
                    <field name="contract_ids" context="{'default_project_id': id}" groups="smart_construction_core.group_sc_cap_contract_user,smart_construction_core.group_sc_cap_contract_manager">
                        <tree editable="bottom">
                            <field name="name"/>
                            <field name="subject"/>
                            <field name="type"/>
                            <field name="category_id"/>
                            <field name="partner_id"/>
                            <field name="date_contract"/>
                            <field name="amount_final"/>
                            <field name="state"/>
                        </tree>
                    </field>
                </page>
                <page string="工程资料" groups="smart_construction_core.group_sc_cap_project_read">
                    <group>
                        <field name="document_count" readonly="1"/>
                        <field name="document_required_count" readonly="1"/>
                        <field name="document_missing_count" readonly="1"/>
                    </group>
                    <field name="document_ids" context="{'default_project_id': id}" groups="smart_construction_core.group_sc_super_admin">
                        <tree editable="bottom">
                            <field name="name"/>
                            <field name="wbs_id"/>
                            <field name="doc_type_id"/>
                            <field name="doc_subtype_id"/>
                            <field name="is_mandatory"/>
                            <field name="version"/>
                            <field name="date_doc"/>
                            <field name="state"/>
                            <field name="attachment_count"/>
                        </tree>
                    </field>
                </page>
                <page string="驾驶舱" groups="smart_construction_core.group_sc_cap_finance_read">
                    <group>
                        <group>
                            <field name="contract_amount" readonly="1"/>
                            <field name="subcontract_amount" readonly="1"/>
                            <field name="dashboard_revenue_actual" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_cost_actual" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_profit_actual" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                        </group>
                        <group>
                            <field name="dashboard_invoice_amount" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_payment_in" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_payment_out" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_progress_rate" readonly="1"/>
                            <field name="dashboard_document_completion" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>

            <!-- 协作/系统放到所有业务页签之后，避免干扰主流程 -->
            <xpath expr="//sheet/notebook/page[last()]" position="after">
                <page string="协作 / 系统" name="sc_system">
                    <group>
                        <field name="task_ids"/>
                        <field name="collaborator_ids"/>
                        <field name="analytic_account_id"/>
                    </group>
                </page>
            </xpath>

            <!-- 协作入口仅对经办/审批与超管可见，PM 主路径隐藏 -->
            <xpath expr="//div[hasclass('o_chatter') or hasclass('oe_chatter')]" position="attributes">
                <attribute name="groups">smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager,smart_construction_core.group_sc_cap_contract_user,smart_construction_core.group_sc_cap_contract_manager,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>

        </field>
    </record>

    <!-- Hide task execution entry points from PM; keep for project users/managers and system admin. -->
    <record id="view_project_hide_task_buttons_sc_core" model="ir.ui.view">
        <field name="name">project.project.form.sc.core.hide.task.buttons</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="priority">5</field>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']//button[@name='action_view_tasks']" position="attributes">
                <attribute name="groups">base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>
            <xpath expr="//div[@name='button_box']//button[@name='project_update_all_action']" position="attributes">
                <attribute name="groups">base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>
        </field>
    </record>

    <record id="view_project_hide_task_tree_actions_sc_core" model="ir.ui.view">
        <field name="name">project.project.tree.sc.core.hide.task.actions</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.view_project"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_view_tasks']" position="attributes">
                <attribute name="groups">base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>
        </field>
    </record>

    <record id="view_project_hide_task_simplified_actions_sc_core" model="ir.ui.view">
        <field name="name">project.project.form.simplified.sc.core.hide.task.actions</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.project_project_view_form_simplified_footer"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_view_tasks']" position="attributes">
                <attribute name="groups">base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>
        </field>
    </record>

    <record id="view_project_hide_task_kanban_actions_sc_core" model="ir.ui.view">
        <field name="name">project.project.kanban.sc.core.hide.task.actions</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.view_project_kanban"/>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <xpath expr="//kanban[@action='action_view_tasks']" position="attributes">
                <attribute name="action"></attribute>
                <attribute name="type"></attribute>
            </xpath>
            <xpath expr="//a[@name='action_view_tasks' and not(contains(concat(' ', normalize-space(@class), ' '), ' o_project_kanban_box '))]" position="replace">
                <a name="action_view_tasks" type="object" groups="smart_construction_core.group_sc_task_entry_access">Tasks</a>
            </xpath>
            <xpath expr="//a[contains(concat(' ', normalize-space(@class), ' '), ' o_project_kanban_box ') and @name='action_view_tasks']" position="replace">
                <a class="o_project_kanban_box" name="action_view_tasks" type="object" groups="smart_construction_core.group_sc_task_entry_access">
                    <div>
                        <span class="o_value"><t t-esc="record.open_task_count.value"/></span>
                        <span class="o_label ms-1"><t t-esc="record.label_tasks.value"/></span>
                    </div>
                </a>
            </xpath>
            <xpath expr="//a[@name='action_get_list_view']" position="attributes">
                <attribute name="groups">base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>
            <xpath expr="//a[@name='action_view_tasks_analysis']" position="replace">
                <a name="action_view_tasks_analysis" type="object" groups="smart_construction_core.group_sc_task_entry_access">Tasks Analysis</a>
            </xpath>
            <xpath expr="//a[@name='action_project_task_burndown_chart_report']" position="attributes">
                <attribute name="groups">smart_construction_core.group_sc_task_entry_access</attribute>
            </xpath>
        </field>
    </record>

    <record id="view_project_hide_task_kanban_inherit_actions_sc_core" model="ir.ui.view">
        <field name="name">project.project.kanban.inherit.sc.core.hide.task.actions</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.project_view_kanban_inherit_project"/>
        <field name="arch" type="xml">
            <xpath expr="//a[@name='project_update_all_action']" position="attributes">
                <attribute name="groups">base.group_system,smart_construction_core.group_sc_task_entry_access,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>
        </field>
    </record>

</odoo>
