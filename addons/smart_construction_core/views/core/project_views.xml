<odoo>
    <record id="action_project_budget_quick" model="ir.actions.act_window">
        <field name="name">项目预算</field>
        <field name="res_model">project.budget</field>
        <field name="view_mode">tree,form,graph</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_user')), (4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
    </record>

    <record id="action_project_cost_ledger_quick" model="ir.actions.act_window">
        <field name="name">成本台账</field>
        <field name="res_model">project.cost.ledger</field>
        <field name="view_mode">tree,form,pivot,graph</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_user')), (4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
        <field name="context">{'default_project_id': active_id, 'search_default_project_id': active_id}</field>
        <field name="domain">context.get('default_project_id') and [('project_id','=',context.get('default_project_id'))] or []</field>
    </record>

    <record id="action_project_progress_quick" model="ir.actions.act_window">
        <field name="name">进度计量</field>
        <field name="res_model">project.progress.entry</field>
        <field name="view_mode">tree,form</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_cost_user')), (4, ref('smart_construction_core.group_sc_cap_cost_manager'))]"/>
    </record>

    <record id="action_project_contract_overview" model="ir.actions.act_window">
        <field name="name">项目合同汇总</field>
        <field name="res_model">construction.contract</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'searchpanel_default_project_id': True}</field>
        <field name="groups_id" eval="[(4, ref('smart_construction_core.group_sc_cap_contract_user')), (4, ref('smart_construction_core.group_sc_cap_contract_manager'))]"/>
    </record>

    <!-- 项目表单扩展：施工信息 + 工程资料 + 合同 -->
    <record id="view_project_form_sc_core" model="ir.ui.view">
        <field name="name">project.project.form.sc.core</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="arch" type="xml">

            <!-- 顶部状态栏：使用生命周期字段，避免任务态混入 -->
            <xpath expr="//form/header//field[@name='stage_id']" position="replace">
                <field name="lifecycle_state"
                       widget="statusbar"
                       statusbar_visible="draft,in_progress,paused,done,closing,warranty,closed"/>
            </xpath>

            <!-- 重做按钮区：仅保留主流程按钮 -->
            <xpath expr="//sheet/div[@name='button_box']" position="replace">
                <div class="oe_button_box" name="button_box">
                    <button name="action_open_wbs" string="工程结构" type="object" class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <button name="action_open_boq_import" string="工程量清单" type="object" class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    <button name="%(smart_construction_core.action_project_budget_quick)d"
                            string="预算/成本"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"
                            context="{'default_project_id': id, 'search_default_project_id': id}"/>
                    <button name="%(smart_construction_core.action_project_contract_overview)d"
                            string="合同"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_contract_user,smart_construction_core.group_sc_cap_contract_manager"
                            context="{'search_default_project_id': [id], 'default_project_id': id}"/>
                    <button name="%(smart_construction_core.action_project_material_plan)d"
                            string="物资/采购"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_material_user,smart_construction_core.group_sc_cap_material_manager"
                            context="{'search_default_project_id': [id], 'default_project_id': id}"/>
                    <button name="%(smart_construction_core.action_sc_finance_dashboard)d"
                            string="结算/财务"
                            type="action"
                            class="oe_stat_button"
                            groups="smart_construction_core.group_sc_cap_finance_user,smart_construction_core.group_sc_cap_finance_manager"
                            context="{'search_default_project_id': [id], 'default_project_id': id}"/>
                </div>
            </xpath>

            <!-- 概览/施工/协作页插入到原生 notebook 开头 -->
            <xpath expr="//sheet/notebook/page[1]" position="before">
                <div class="o_sc_project_overview row" style="margin: 8px 0 12px 0;">
                    <div class="col-12">
                        <div class="alert alert-info" role="alert" style="margin-bottom: 8px;">
                            <strong>项目概览：</strong>快速查看合同与资金执行情况（试用版）。
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">已付款合同额</div>
                            <div class="h3"><field name="pay_contract_total" widget="monetary" readonly="1"/></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">已结算金额</div>
                            <div class="h3"><field name="pay_settlement_total" widget="monetary" readonly="1"/></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">已付款金额</div>
                            <div class="h3"><field name="pay_paid_total" widget="monetary" readonly="1"/></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">未付款金额</div>
                            <div class="h3"><field name="pay_unpaid_total" widget="monetary" readonly="1"/></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">BOQ 状态</div>
                            <div class="h3"><field name="boq_line_count" readonly="1"/></div>
                            <div class="text-muted">已导入</div>
                            <div><field name="boq_imported" readonly="1"/></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">BOQ 合价(叶子)</div>
                            <div class="h3"><field name="boq_amount_leaf_total" widget="monetary" readonly="1"/></div>
                            <div class="text-muted">BOQ 版本</div>
                            <div><field name="boq_version_latest" readonly="1"/></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card p-3">
                            <div class="text-muted">工程结构状态</div>
                            <div class="h3"><field name="wbs_node_count" readonly="1"/></div>
                            <div class="text-muted">已就绪</div>
                            <div><field name="wbs_ready" readonly="1"/></div>
                        </div>
                    </div>
                </div>
                <page string="项目概览" name="sc_overview">
                    <group col="4" string="项目概览">
                        <field name="name"/>
                        <field name="project_code" readonly="1"/>
                        <field name="project_type_id"/>
                        <field name="project_category_id"/>
                        <field name="manager_id"/>
                        <field name="partner_id"/>
                        <field name="owner_id"/>
                    </group>
                    <group col="4" string="关键指标" groups="smart_construction_core.group_sc_cap_finance_read">
                        <field name="pay_contract_total" readonly="1"/>
                        <field name="pay_settlement_total" readonly="1"/>
                        <field name="pay_paid_total" readonly="1"/>
                        <field name="pay_unpaid_total" readonly="1"/>
                    </group>
                </page>
                <page string="投标管理" name="sc_tender" groups="smart_construction_core.group_sc_cap_project_user">
                    <field name="tender_bid_ids" context="{'default_project_id': id, 'default_state': 'prepare'}">
                        <tree string="投标记录" editable="bottom">
                            <field name="tender_name"/>
                            <field name="tender_round"/>
                            <field name="owner_id"/>
                            <field name="bid_amount"/>
                            <field name="amount_total"/>
                            <field name="state"/>
                            <field name="deadline"/>
                        </tree>
                    </field>
                </page>
                <page string="施工信息" name="sc_construction" groups="smart_construction_core.group_sc_cap_project_read">
                    <group col="4" string="施工项目信息">
                        <field name="project_code" readonly="1"/>
                        <field name="project_type_id"/>
                        <field name="project_category_id"/>
                        <field name="lifecycle_state"/>
                        <field name="phase_key" invisible="1"/>
                        <field name="owner_contact"/>
                        <field name="location"/>
                        <field name="contract_no"/>
                        <field name="start_date"/>
                        <field name="end_date"/>
                    </group>
                    <group col="4" string="项目责任人">
                        <field name="manager_id"/>
                        <field name="cost_manager_id"/>
                        <field name="doc_manager_id"/>
                    </group>
                    <group string="职责分工">
                        <field name="responsibility_ids">
                            <tree editable="bottom">
                                <field name="role_key"/>
                                <field name="user_id"/>
                                <field name="note"/>
                            </tree>
                        </field>
                    </group>
                    <group col="4" string="成本与进度" groups="smart_construction_core.group_sc_cap_cost_read">
                        <field name="budget_active_id" readonly="1" options="{'no_create': True}"/>
                        <field name="budget_active_cost_target" readonly="1"/>
                        <field name="budget_active_revenue_target" readonly="1"/>
                        <field name="cost_ledger_amount_actual" readonly="1"/>
                        <field name="cost_budget_gap" readonly="1"/>
                        <field name="progress_rate_latest" readonly="1"/>
                        <field name="progress_entry_count" readonly="1"/>
                        <button name="action_open_cost_ledger"
                                string="查看台账明细"
                                type="object"
                                class="btn-secondary"
                                groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                        <button name="action_open_progress_entries"
                                string="查看进度明细"
                                type="object"
                                class="btn-secondary"
                                groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager"/>
                    </group>
                </page>
            </xpath>

            <!-- notebook 中重排业务页签，保证系统/描述/设置靠后 -->
            <xpath expr="//sheet/notebook/page[@name='sc_construction']" position="after">
                <page string="WBS结构" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager">
                    <field name="wbs_ids" context="{'default_project_id': id}">
                        <tree editable="bottom">
                            <field name="sequence"/>
                            <field name="code"/>
                            <field name="name"/>
                            <field name="parent_id"/>
                            <field name="level"/>
                            <field name="active"/>
                        </tree>
                    </field>
                </page>
                <page string="工程量清单" name="boq_tab" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager">
                    <group col="2">
                        <group string="清单操作">
                            <button string="导入清单"
                                    type="object"
                                    class="oe_highlight"
                                    name="action_open_boq_import"/>
                            <button string="生成工程结构"
                                    type="object"
                                    class="btn-secondary"
                                    name="action_generate_wbs_from_boq"/>
                            <button string="生成施工任务"
                                    type="action"
                                    class="btn-secondary"
                                    name="%(smart_construction_core.action_project_task_from_boq_wizard)d"/>
                            <button string="工程量清单分析"
                                    type="action"
                                    class="btn-secondary"
                                    name="%(smart_construction_core.action_project_boq_line_analysis)d"
                                    context="{'search_default_project_id': [id]}"/>
                        </group>
                        <group string="维护" groups="smart_construction_core.group_sc_cap_cost_manager">
                            <button string="重建工程量清单层级"
                                    type="object"
                                    class="btn-secondary"
                                    name="action_rebuild_boq_hierarchy"/>
                            <button string="校验工程量清单"
                                    type="object"
                                    class="btn-secondary"
                                    name="action_validate_boq"/>
                        </group>
                    </group>
                    <group string="清单汇总">
                        <field name="boq_amount_total" readonly="1"/>
                        <field name="boq_amount_building" readonly="1"/>
                        <field name="boq_amount_installation" readonly="1"/>
                    </group>
                    <field name="boq_line_ids" context="{'default_project_id': id}">
                        <tree editable="bottom">
                            <field name="section_type"/>
                            <field name="category"/>
                            <field name="is_provisional"/>
                            <field name="source_type"/>
                            <field name="version"/>
                            <field name="sequence"/>
                            <field name="code"/>
                            <field name="name"/>
                            <field name="single_name"/>
                            <field name="unit_name"/>
                            <field name="spec"/>
                            <field name="uom_id"/>
                            <field name="quantity" sum="工程量合计"/>
                            <field name="price"/>
                            <field name="amount" readonly="1"/>
                            <field name="amount_leaf" sum="清单金额合计" optional="hide"/>
                            <field name="cost_item_id"/>
                            <field name="remark"/>
                            <field name="structure_id" readonly="1"/>
                        </tree>
                        <form string="工程量清单">
                            <group>
                                <field name="sequence"/>
                                <field name="code"/>
                                <field name="name"/>
                                <field name="spec"/>
                                <field name="uom_id"/>
                                <field name="quantity"/>
                                <field name="price"/>
                                <field name="amount" readonly="1"/>
                                <field name="cost_item_id"/>
                                <field name="remark"/>
                                <field name="source_type"/>
                                <field name="version"/>
                                <field name="structure_id" readonly="1"/>
                                <field name="task_id" readonly="1"/>
                            </group>
                        </form>
                    </field>
                </page>
                <page string="工程结构" groups="smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager">
                    <field name="work_ids" context="{'default_project_id': id}" domain="[('project_id','=',id)]">
                        <tree editable="bottom">
                            <field name="sequence" widget="handle"/>
                            <field name="level_type"/>
                            <field name="code"/>
                            <field name="name"/>
                            <field name="parent_id"/>
                            <field name="boq_quantity_total"/>
                            <field name="boq_amount_total"/>
                        </tree>
                    </field>
                    <group string="工程结构（WBS自动生成）">
                        <field name="structure_ids" context="{'default_project_id': id}">
                            <tree string="工程结构" editable="bottom">
                                <field name="structure_type"/>
                                <field name="code"/>
                                <field name="name"/>
                                <field name="level" readonly="1"/>
                                <field name="qty_total" readonly="1"/>
                                <field name="amount_total" readonly="1"/>
                                <field name="sequence"/>
                            </tree>
                            <form string="工程结构">
                                <sheet>
                                    <group>
                                        <field name="structure_type"/>
                                        <field name="code"/>
                                        <field name="name"/>
                                        <field name="parent_id"/>
                                        <field name="level" readonly="1"/>
                                        <field name="sequence"/>
                                    </group>
                                    <group string="挂接清单" colspan="2">
                                        <field name="boq_line_ids" readonly="1">
                                            <tree>
                                                <field name="code"/>
                                                <field name="name"/>
                                                <field name="quantity"/>
                                                <field name="uom_id"/>
                                                <field name="amount"/>
                                            </tree>
                                        </field>
                                    </group>
                                </sheet>
                            </form>
                        </field>
                    </group>
                </page>
                <page string="合同" groups="smart_construction_core.group_sc_cap_contract_read">
                    <group>
                        <field name="contract_count" readonly="1"/>
                        <field name="contract_income_total" readonly="1"/>
                        <field name="contract_expense_total" readonly="1"/>
                    </group>
                    <field name="contract_ids" context="{'default_project_id': id}" groups="smart_construction_core.group_sc_cap_contract_user,smart_construction_core.group_sc_cap_contract_manager">
                        <tree editable="bottom">
                            <field name="name"/>
                            <field name="subject"/>
                            <field name="type"/>
                            <field name="category_id"/>
                            <field name="partner_id"/>
                            <field name="date_contract"/>
                            <field name="amount_final"/>
                            <field name="state"/>
                        </tree>
                    </field>
                </page>
                <page string="工程资料" groups="smart_construction_core.group_sc_cap_project_read">
                    <group>
                        <field name="document_count" readonly="1"/>
                        <field name="document_required_count" readonly="1"/>
                        <field name="document_missing_count" readonly="1"/>
                    </group>
                    <field name="document_ids" context="{'default_project_id': id}" groups="smart_construction_core.group_sc_super_admin">
                        <tree editable="bottom">
                            <field name="name"/>
                            <field name="wbs_id"/>
                            <field name="doc_type_id"/>
                            <field name="doc_subtype_id"/>
                            <field name="is_mandatory"/>
                            <field name="version"/>
                            <field name="date_doc"/>
                            <field name="state"/>
                            <field name="attachment_count"/>
                        </tree>
                    </field>
                </page>
                <page string="驾驶舱" groups="smart_construction_core.group_sc_cap_finance_read">
                    <group>
                        <group>
                            <field name="contract_amount" readonly="1"/>
                            <field name="subcontract_amount" readonly="1"/>
                            <field name="dashboard_revenue_actual" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_cost_actual" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_profit_actual" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                        </group>
                        <group>
                            <field name="dashboard_invoice_amount" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_payment_in" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_payment_out" readonly="1" groups="account.group_account_readonly,smart_construction_core.group_sc_cap_finance_read"/>
                            <field name="dashboard_progress_rate" readonly="1"/>
                            <field name="dashboard_document_completion" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>

            <!-- 协作/系统放到所有业务页签之后，避免干扰主流程 -->
            <xpath expr="//sheet/notebook/page[last()]" position="after">
                <page string="协作 / 系统" name="sc_system">
                    <group>
                        <field name="task_ids"/>
                        <field name="collaborator_ids"/>
                        <field name="analytic_account_id"/>
                    </group>
                </page>
            </xpath>

            <!-- 协作入口仅对经办/审批与超管可见，PM 主路径隐藏 -->
            <xpath expr="//div[hasclass('o_chatter') or hasclass('oe_chatter')]" position="attributes">
                <attribute name="groups">smart_construction_core.group_sc_cap_cost_user,smart_construction_core.group_sc_cap_cost_manager,smart_construction_core.group_sc_cap_contract_user,smart_construction_core.group_sc_cap_contract_manager,smart_construction_core.group_sc_super_admin</attribute>
            </xpath>

        </field>
    </record>

</odoo>
