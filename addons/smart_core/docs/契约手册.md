
---

# 一、总体目标与设计原则

**目标**

1. 前端零推理：契约=页面=行为=首屏数据（with\_data）。
2. 单一入口：`POST /api/contract/get` 承载 nav/menu/action/model 四类入口。
3. 统一“契约 + 意图”闭环：契约用于描述，意图用于执行，执行后刷新契约。
4. 强一致权限：字段/按钮/数据权限一次下发，前后端一致。
5. 高可用与可观测：ETag/304 缓存、版本化（view/perm/search/actions）、埋点日志。

**原则**

* **结构驱动**：所有 UI/交互/数据的“结构语义”在后端解释完成，前端只渲染。
* **最少接口**：契约入口 + 意图入口（按钮/动作/报表/向导）。
* **强可缓存**：契约可长缓存，数据分页/筛选按参数控制变更。
* **可插拔**：契约生成服务暴露 Hook（模型、视图、权限、工作流、统计、报表）。
* **Odoo 对齐**：沿用 domain/attrs 语法、ir.rule、ACL、记录规则、视图语义。

---

# 二、分层架构（逻辑与部署）

```
┌───────────────────────────────────────────────────────────────┐
│                         前端（Vue3）                          │
│  AutoPage 渲染引擎（Tree/Form/Kanban/Pivot/Calendar/Gantt/Graph）
│  合同态按钮/搜索面板/状态条/协作区/报表入口/分页与缓存（ETag）   │
│  IntentClient（意图总线）  ContractClient（契约客户端）        │
└──────────────▲─────────────────────────────▲──────────────────┘
               │契约（合并首屏数据）         │意图执行
               │POST /api/contract/get       │POST /api/intent/execute
┌──────────────┴─────────────────────────────┴──────────────────┐
│                       应用网关层（API）                       │
│  ContractController（V2 单入口）  IntentController（统一执行） │
│  ETag/If-None-Match  统一错误模型  鉴权（auth='user'）         │
└──────────────▲─────────────────────────────▲──────────────────┘
               │调用                                           │
┌──────────────┴───────────────────────────────────────────────┐
│                   契约聚合服务（Service Hub）                 │
│  View Semantic Engine（视图语义解析/归一化）                  │
│  Permission Aggregator（ACL/ir.rule/字段权限/按钮权限）       │
│  Search Schema & Default（filters/group_by/默认domain/order） │
│  Workflow Composer（状态机/过渡/按钮）                        │
│  Data Provider（search_read/read/read_group/calendar/gantt）  │
│  ValueSet Provider（selection/many2one值域，懒加载+缓存）     │
│  Report & Action Binder（报表/动作/向导 → 按钮/行操作）       │
│  Version & ETag Builder（view|perm|search|actions → etag）    │
│  Metrics & Audit（耗时/缓存命中/安全审计）                    │
└──────────────▲──────────────────────────────────────────────┘
               │Odoo ORM / 元数据 / 配置中心 / 队列
┌──────────────┴──────────────────────────────────────────────┐
│                         Odoo 核心层                         │
│  ir.model / ir.ui.view / ir.rule / res.groups / mail.*      │
│  project.* / account.* / 自研模型（contract/cost/quality…） │
│  app.* 配置域：model/view/permission/workflow/search/action │
│  cron/queue_job（异步、批量）                                │
└─────────────────────────────────────────────────────────────┘
```

---

# 三、关键子系统设计

## 1) ContractController（V2 单入口）

* **路由**：`POST /api/contract/get`
* **参数**（精简）：`subject`（nav|menu|action|model）、`id|action_id|model`、`view_type`、`record_id`、`with_data`、`domain/order/limit/offset`、`measures/groupby`、`calendar/gantt`、`context`。
* **返回**：`{ ok, data, meta }`，其中 `data` 覆盖：`head/permissions/rules/search/views/fields/buttons/workflow/collab/reports/ui/data`。
* **缓存**：计算 `etag`；若携带 `If-None-Match` 且命中，直接 304。
* **错误**：HTTP 200 + `{ ok:false, error }` 统一处理；致命异常 5xx。

> 实现要点：控制器仅做参数校验、鉴权、缓存协商，核心拼装交给 Service Hub。

## 2) IntentController（意图总线）

* **路由**：`POST /api/intent/execute`
* **语义**：前端按钮/行操作/菜单动作/报表点击 → 统一意图：

  * `form.open`, `tree.open`, `action.execute`, `button.execute`,
  * `report.print`, `wizard.open`, `attachment.upload`, `record.create/update/delete` …
* **事务与权限**：在执行前进行 **同源权限校验**（与契约下发一致），失败则返回“禁用/原因”。
* **完成后**：回传执行结果（可选携带 `refresh: contract_params`），前端据此**再次拉取契约**刷新页面。

## 3) View Semantic Engine（视图语义解析引擎）

* 从 `ir.ui.view` 原生 XML 与扩展配置（`app.view.config`）**保真解析**到统一结构：

  * `tree/form/kanban/pivot/calendar/gantt/graph` 全视图类型支持；
  * `modifiers/attrs` 统一成 `readonly/invisible/required` 的 domain 表达式；
  * Header/Statusbar/Notebook/Chatter/Activity/Attachment/oe\_button\_box/oe\_stat\_button 等语义位全部结构化；
  * **避免前端推理**，所有“显示/禁用/必填/条件”在服务端计算为可解释表达式或布尔位。

## 4) Permission Aggregator（权限聚合）

* 汇总 ACL、`ir.rule`、字段级权限、按钮/动作可见性。
* **契约下发**：`permissions`（CRUD）、字段 `readonly/required`、按钮 `visible/enabled`，以及**默认 domain/order**。
* **一致性**：契约与数据读写同源校验，避免“能看/不能做”的割裂。

## 5) Search Schema & Default

* 将**搜索条件/分组**以结构化给前端：`filters/group_by/facets`。
* 约定 `filters[].domain` 使用 Odoo 标准语法，可含动态占位（如 `"uid"`）。
* 支持**首屏默认条件**与**快速切片**。

## 6) Data Provider（数据提供器）

* `with_data` 时按活跃视图返回：

  * 列表：`search_read`（只取列+must-have 字段）。
  * 表单：`read(record_id)`。
  * 聚合：`read_group`（pivot/graph）。
  * 日历/甘特：`date_start/date_stop/progress/color` 字段映射。
* 分页：`limit/offset` + `next_offset`。
* 性能：**字段列裁剪**、索引/预取、懒加载多对一值域。

## 7) ValueSet Provider（值域/选择项）

* `selection`：全局缓存（语言隔离）。
* `many2one`：懒加载 + LRU 缓存，附带 `domain` 约束（角色/状态/公司）。
* 前端仅在契约未覆盖时才“按需取值域”（保留二次接口但尽量不用）。

## 8) Workflow & Actions Binder

* 从模型方法/服务器动作/报告/向导**绑定**到契约的 `buttons`、`row_actions`。
* `workflow.states/transitions` 明确列出，便于前端状态条与按钮可用态联动。

## 9) Version & ETag Builder / Metrics & Audit

* `meta.version = "model:12|view:34|perm:7|search:5|actions:9"`
* `etag` 基于版本片段 + 关键查询参数（view\_type/domain/order/limit/groupby…）。
* 记录 `elapsed_ms / cache_hit / warn`；便于端到端观测。

---

# 四、前端（Vue3）落地形态

## 1) 路由与首屏策略

* 登录成功：`contract.get {subject:'nav'}` → 叶子菜单**全部注入**路由 `/m/:menuId`。
* 进入菜单：`contract.get {subject:'menu', id, with_data:true}` → **一跳渲染首屏**。
* 切换视图/搜索/分页：仍旧调 `contract.get`，仅变更参数，不再另走杂散接口。

## 2) AutoPage 渲染引擎

* 解析 `views[active] + fields + modifiers + search + buttons + workflow + collab` → 页面骨架。
* 表单：支持 `sheet/group/notebook/chatter/statusbar` 等全部布局与语义。
* 列表：行操作、右上角按钮（place:'header'|'row'）。
* 统计视图：pivot/graph/calendar/gantt **立即可用**。
* 按钮点击 → `IntentClient.execute()` → 成功后刷新契约。

## 3) ContractClient & IntentClient

* **ContractClient**：自动处理 ETag/If-None-Match；命中 304 则复用缓存。
* **IntentClient**：统一封装参数、兜底错误、冲突提示（并发写）。
* **状态管理**：Pinia 持有 `contract cache`（key=etag），路由切换回退秒开。

---

# 五、数据流 & 交互闭环（典型）

**示例：菜单 → 列表 → 表单 → 执行按钮 → 回写刷新**

1. `/m/392`（项目列表）
2. `contract.get { subject:'menu', id:392, view_type:'tree,form', with_data:true, limit:50 }`
3. 前端渲染列表与搜索面板；用户点某一行“打开”
4. `intent.execute { name:'form.open', model:'project.project', record_id:123 }`（或直接路由参数触发表单契约）
5. 表单渲染后，点击“确认”：

   * `intent.execute { name:'button.execute', model, method:'action_confirm', record_id:123 }`
   * 成功 → `contract.get`（携带 `record_id`）刷新，状态条变更、按钮联动生效。

---

# 六、权限、安全与合规

* **统一鉴权**：API 层要求 `auth='user'`；所有契约字段/按钮/数据**与实际权限一致**。
* **数据范围**：`ir.rule` → `rules.record_rules` 下发默认域；前端不可越权修改。
* **字段安全**：敏感字段在契约中直接过滤，不下发。
* **意图执行**：再次做权限校验（模型+方法+记录域）。
* **审计**：Intent 执行写审计日志（用户/时间/参数/IP/影响记录）。

---

# 七、与现有模块的映射与扩展位

结合你的业务清单（计划/成本/质量/安全/资金等），后端保持 **app.* 配置域*\* 做可插拔扩展：

* `app.model.config`：模型白名单、显示名、identity（pk/display）
* `app.view.config`：视图增强（隐藏/重排/语义标签/统计视图定义）
* `app.permission.config`：字段掩码、按钮可见、角色矩阵
* `app.search.config`：默认 filters/group\_by、多公司隔离
* `app.workflow.config`：状态机与按钮绑定
* `app.action.config`：报表/服务器动作/向导绑定

> 通过这些配置，成本/合约/质量/安全的**扩展模型**可以被契约自动“收编”为可视化页面与行为，无需前端改造。

---

# 八、性能与稳定性要点

* **契约缓存命中率** ≥ 80%（同菜单首屏 & 切换轻量参数）。
* **列表列裁剪**：仅取 `views.tree.columns + must-have`。
* **值域缓存**：`selection` 全局、`many2one` LRU（带 domain 维度）。
* **大表分页**：limit 严格控制，后台提供 `next_offset`。
* **读写分离**（可选）：读走从库，写走主库（视你的部署）。
* **异步作业**：批量/导出/报表生成使用队列（cron/queue\_job），意图返回任务ID并“完成即刷新”。

---

# 九、DevOps 与部署建议

* **容器**：PostgreSQL 15 + Odoo 17 + Nginx（反代/压缩/缓存控制）。
* **环境**：多环境（dev/stage/prod），Feature Flag 控制“Contract 2.0 开关”。
* **观测**：Nginx 访问日志 + Odoo 日志 + 应用埋点（契约生成耗时、304 命中、意图成功率）。
* **回滚**：契约构建器/解析器版本可灰度（配置项开关）。
* **备份**：数据库定时物理备份 + 附件对象存储（MinIO/S3）。

---

# 十、落地路线图（4 周）

**第 1 周：骨架起航**

* 搭建 `ContractController/IntentController` 空壳；
* `subject:'nav'|'menu'` 的最小可用契约（tree/form 两类）；
* AutoPage 首屏渲染（列表/表单/按钮点击 → Intent 打通）。

**第 2 周：视图与权限**

* 视图语义解析覆盖 notebook/statusbar/chatter/button\_box/stat\_button；
* 权限聚合落地（字段/按钮/默认域），前后端一致性校验；
* ETag/304 生效，契约缓存层就绪。

**第 3 周：多视图与搜索**

* pivot/graph/calendar/gantt 接入 Data Provider；
* search.filters/group\_by/默认筛选；
* 值域缓存策略（selection/many2one）。

**第 4 周：可观测与验收**

* 版本与 etag 维度完善（view/perm/search/actions）；
* 指标面板：耗时、命中率、失败类目；
* 覆盖 3 个业务线（如“计划/合同/质量”）的端到端验收。

---

# 十一、验收清单（关键用例）

* ✅ **首屏一跳渲染**：with\_data，无额外接口。
* ✅ **多视图切换**：tree/form/pivot/calendar/gantt/graph 均可用。
* ✅ **权限一致**：禁用态/隐藏/只读与后端真实权限一致。
* ✅ **按钮意图**：执行成功后刷新契约，状态条/按钮联动正确。
* ✅ **缓存有效**：重复进入同菜单 ETag 命中 304。
* ✅ **搜索/分页**：domain/order/limit/offset 正常，next\_offset 前后衔接。
* ✅ **异常模型**：给出 `{ ok:false, error }` 且 UI 友好提示。

---

# 十二、关键代码骨架（示意）

**ContractController（Python/Odoo）**

```python
class ContractController(http.Controller):
    @http.route('/api/contract/get', type='json', auth='user', methods=['POST'])
    def get(self, **payload):
        # 1) 校验 & If-None-Match
        subject = payload.get('subject')
        # 2) 调用服务
        result = request.env['app.contract.service'].sudo().generate_contract(**payload)
        # 3) 构建 ETag/304 & 统一返回
        return {"ok": True, "data": result["data"], "meta": result["meta"]}
```

**IntentController（Python/Odoo）**

```python
class IntentController(http.Controller):
    @http.route('/api/intent/execute', type='json', auth='user', methods=['POST'])
    def exec(self, **payload):
        # 校验权限 → 分发到具体执行器（按钮/动作/报表/向导）
        return {"ok": True, "result": {...}, "refresh": {"subject":"model","model":"...", "record_id": ...}}
```

**Service 入口（示意）**

```python
def generate_contract(self, model=None, view_type='tree,form', view_id=None,
                      record_id=None, with_data=False, domain=None, order=None,
                      limit=50, offset=0, measures=None, groupby=None,
                      calendar=None, gantt=None, context=None):
    # 聚合：视图语义 + 权限 + 搜索 + 工作流 + 数据 + 版本/etag
    return {"data": contract, "meta": meta}
```

**前端 ContractClient（TS）**

```ts
export async function contractGet(body: ContractBody) {
  const etag = cache.key(body)
  const headers: any = {}
  if (etag) headers['If-None-Match'] = etag
  const { data, meta, ok } = await api.post('/api/contract/get', body, { headers })
  if (ok === false) throw new Error(data?.error || 'Contract error')
  if (meta?.etag) cache.set(body, meta.etag, data) // 命中则复用
  return { data, meta }
}
```

---

# 结语

这套“**契约 2.0 + 意图总线**”架构，能把你现在的“结构驱动 + 意图解释”路线**彻底产品化**：

* 前端统一由 **AutoPage** 渲染，真·零推理；
* 后端以 Odoo 能力为内核，契约聚合服务把“视图/权限/工作流/搜索/报表”一次拼装；
* 少接口、强缓存、可观测，能稳步扩张到成本/质量/安全/资金等全模组。

如果你同意，我直接输出**第 1 周任务分解的详细任务清单与验收用例**，并给出你仓库当前目录下应新增的文件树和空实现代码模版，方便你马上开工。
