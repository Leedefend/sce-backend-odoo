# docker-compose.ci.yml
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: sc_test
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: odoo
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/db-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-odoo} -d ${POSTGRES_DB:-sc_test}"]
      interval: 2s
      timeout: 3s
      retries: 30

  redis:
    image: redis:7-alpine
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 3s
      retries: 30

  odoo:
    image: odoo17-odoo:latest
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    # CI 不需要暴露端口；不写 ports 即可
    # ports: []

    volumes:
      - odoodata:/var/lib/odoo
      - ./addons:/mnt/extra-addons
      - ./addons_external:/mnt/addons_external
      # 直接挂最终 conf（不走镜像渲染）
      - ./config/odoo.ci.conf:/etc/odoo/odoo.conf:ro

    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/mnt/extra-addons

    # 直接调用 odoo，避免镜像入口渲染
    entrypoint: ["/usr/bin/odoo"]
    command:
      - "--config=/etc/odoo/odoo.conf"
      - "--db_host=${DB_HOST:-db}"
      - "--db_port=${DB_PORT:-5432}"
      - "--db_user=${DB_USER:-odoo}"
      - "--db_password=${DB_PASSWORD:-odoo}"
      - "-d"
      - "${DB_CI:-sc_odoo}"
      - "-i"
      - "${MODULE:-smart_construction_core}"
      - "--without-demo=${WITHOUT_DEMO:-all}"
      - "${TEST_ENABLE_FLAG:---test-enable}"
      - "--test-tags=${TEST_TAGS:-/smart_construction_core:sc_smoke,sc_gate}"
      - "--stop-after-init"
      - "--log-level=${LOG_LEVEL:-test}"
      - "--log-handler=${LOG_HANDLER:-odoo.tests.result:DEBUG}"
      - "--workers=0"
      - "--max-cron-threads=0"

  # CI 不需要这些，保留但默认不启
  n8n:
    profiles: ["manual"]

  nginx:
    profiles: ["manual"]

volumes:
  pgdata:
  redisdata:
  odoodata:
